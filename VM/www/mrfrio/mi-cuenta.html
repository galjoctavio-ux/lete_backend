<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - Mr. Frío</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="card">
            
            <div id="loading-view">
                <h1>Verificando sesión...</h1>
                <p style="text-align: center;">Por favor, espera un momento.</p>
            </div>

            <div id="login-view" style="display: none;">
                <h1>Acceso a Mi Cuenta</h1>
                <p style="text-align: center;">Ingresa tu correo electrónico para recibir un enlace de acceso seguro a tu portal.</p>
                <form id="form-login">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" required>
                    <button type="submit" id="btn-login">Enviar Enlace de Acceso</button>
                </form>
                <div id="mensaje-login" class="mensaje"></div>
            </div>

            <div id="account-view" style="display: none;">
                <h1>Bienvenido a tu cuenta</h1>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <div id="account-details">
                    </div>
                <button id="btn-logout">Cerrar Sesión</button>
            </div>

        </div>
    </div>

<script>
    // --- PASO 2: CONFIGURACIÓN DE SUPABASE ---
    const SUPABASE_URL = 'https://evpcxzhdkjwbnpwnzyme.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2cGN4emhka2p3Ym5wd256eW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzY2MDIsImV4cCI6MjA3Mzc1MjYwMn0.nxMnRS6e2vnigeOeYWX5tlmAKG5n7Io-Ktpa8TJiwlE';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- PASO 3: MANEJO DE VISTAS Y LÓGICA DE AUTH ---
    document.addEventListener('DOMContentLoaded', () => {
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const accountView = document.getElementById('account-view');
        const accountDetailsDiv = document.getElementById('account-details');

        // --- Lógica de Auth (Login/Logout) ---
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                document.getElementById('user-email').textContent = session.user.email;
                await fetchAccountData(session.access_token); // Carga los datos
                loadingView.style.display = 'none';
                loginView.style.display = 'none';
                accountView.style.display = 'block';
            } else {
                loadingView.style.display = 'none';
                loginView.style.display = 'block';
                accountView.style.display = 'none';
            }
        });

        // --- Lógica del formulario de login ---
        const formLogin = document.getElementById('form-login');
        formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btnLogin = document.getElementById('btn-login');
            const mensajeLogin = document.getElementById('mensaje-login');
            btnLogin.disabled = true;
            btnLogin.textContent = 'Enviando...';
            
            const email = document.getElementById('email').value;

            try {
                // Llama a nuestra API de Node.js (que usa Resend y link cloaking)
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Ocurrió un error.');
                
                mensajeLogin.textContent = data.message;
                mensajeLogin.className = 'mensaje mensaje-exito';
                formLogin.style.display = 'none';
            } catch (error) {
                mensajeLogin.textContent = `Error: ${error.message}`;
                mensajeLogin.className = 'mensaje mensaje-error';
                btnLogin.disabled = false;
                btnLogin.textContent = 'Enviar Enlace de Acceso';
            } finally {
                mensajeLogin.style.display = 'block';
            }
        });

        // --- Lógica del botón de cerrar sesión ---
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await supabase.auth.signOut();
        });


        // --- 🔥 NUEVO: MANEJO DE FORMULARIOS CON EVENT DELEGATION ---
        accountDetailsDiv.addEventListener('submit', (e) => {
            if (e.target.id === 'form-perfil') {
                handleUpdatePerfil(e);
            }
        });

        accountDetailsDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-cancelar')) {
                handleCancelSubscription(e);
            }
        });
    });

    /**
     * 🔥 NUEVO: Función para manejar la actualización del perfil
     */
    async function handleUpdatePerfil(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-actualizar-perfil');
        const msg = document.getElementById('mensaje-perfil');
        btn.disabled = true;
        btn.textContent = 'Actualizando...';
        msg.textContent = '';
        
        const nombre = document.getElementById('nombre').value;
        const whatsapp = document.getElementById('whatsapp').value;

        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error('No hay sesión');
            
            const response = await fetch('/api/actualizar-perfil', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({ nombre: nombre, telefono_whatsapp: whatsapp })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error desconocido');

            msg.textContent = '¡Perfil actualizado con éxito!';
            msg.className = 'mensaje mensaje-exito';
        } catch (error) {
            msg.textContent = `Error: ${error.message}`;
            msg.className = 'mensaje mensaje-error';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Actualizar Perfil';
        }
    }

    /**
     * 🔥 NUEVO: Función para manejar la cancelación de suscripción
     * Llama a la ruta que YA TENÍAS en tu server.js
     */
    async function handleCancelSubscription(e) {
        e.preventDefault();
        const btn = e.target;
        const deviceId = btn.dataset.deviceId;

        if (!confirm(`¿Estás seguro de que deseas cancelar la suscripción para el dispositivo ${deviceId}?\n\nTu servicio continuará hasta el final del ciclo de pago, pero no se te volverá a cobrar.`)) {
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Cancelando...';

        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) throw new Error('No hay sesión');

            // Llama a la ruta que ya existía en tu server.js
            const response = await fetch('/api/cancelar-suscripcion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({ device_id: deviceId })
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error desconocido');

            // Éxito
            alert('Suscripción programada para cancelación. No se te volverá a cobrar.');
            // Recargamos los datos para que se actualice el estado a "cancelled"
            await fetchAccountData(session.access_token); 

        } catch (error) {
            alert(`Error al cancelar: ${error.message}`);
            btn.disabled = false;
            btn.textContent = 'Cancelar Suscripción';
        }
    }


    /**
     * 🔥 MODIFICADO: Función para obtener y RENDERIZAR los datos de la cuenta
     */
    async function fetchAccountData(token) {
        const detailsDiv = document.getElementById('account-details');
        detailsDiv.innerHTML = '<p>Cargando datos del perfil...</p>';
        try {
            const response = await fetch('/api/mi-cuenta', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.statusText}`);
            }
            const data = await response.json();

            // --- ESTA ES LA PARTE QUE CAMBIA ---
            const perfil = data.perfil;
            
            // Sacar solo los 10 dígitos del teléfono para mostrarlo
            let telefonoActual = '';
            if (perfil.telefono_whatsapp && perfil.telefono_whatsapp.startsWith('+521')) {
                telefonoActual = perfil.telefono_whatsapp.substring(4); // Quita el +521
            }

            let html = '<h3>Perfil</h3>';
            html += `<form id="form-perfil" class="form-perfil">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" name="nombre" value="${perfil.nombre || ''}">
                        
                        <label for="whatsapp">WhatsApp (10 dígitos para notificaciones):</label>
                        <input type="tel" id="whatsapp" name="whatsapp" value="${telefonoActual}" maxlength="10" placeholder="Ej: 3312345678">
                        
                        <button type="submit" id="btn-actualizar-perfil">Actualizar Perfil</button>
                        <div id="mensaje-perfil" class="mensaje" style="display: block;"></div>
                     </form>`;

            html += `<hr><h3>Dispositivos</h3>`;

            if (data.dispositivos && data.dispositivos.length > 0) {
                data.dispositivos.forEach(disp => {
                    html += `<div class="dispositivo">
                                <p><strong>ID:</strong> ${disp.device_id}</p>
                                <p><strong>Plan:</strong> ${disp.planes_lete ? disp.planes_lete.nombre_plan : 'N/A'}</p>
                                <p><strong>Estado:</strong> ${disp.estado}</p>`;
                    
                    // Añadir botón de cancelar si no está cancelado
                    if (disp.estado !== 'cancelled' && perfil.subscription_status !== 'cancelled') {
                         html += `<button class="btn-cancelar" data-device-id="${disp.device_id}">Cancelar Suscripción</button>`;
                    } else if (perfil.subscription_status === 'cancelled') {
                         html += `<p><em>Suscripción programada para cancelación.</em></p>`;
                    }
                    
                    html += `</div>`;
                });
            } else {
                html += '<p>No tienes dispositivos asociados.</p>';
            }
            
            detailsDiv.innerHTML = html;

        } catch (error) {
            console.error('Error obteniendo datos de la cuenta:', error);
            detailsDiv.innerHTML = `<p class="mensaje-error">No se pudieron cargar los datos de tu cuenta. Intenta recargar la página.</p>`;
        }
    }
</script>