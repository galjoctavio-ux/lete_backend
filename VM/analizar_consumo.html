<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Energ√©tico Avanzado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-wrapper { position: relative; display: inline-block; margin: 20px 0; }
        .file-input-wrapper input[type=file] { display: none; }

        .file-input-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: transform 0.2s;
            display: inline-block;
        }

        .file-input-label:hover { transform: scale(1.05); }

        .config-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .config-item { display: flex; flex-direction: column; }
        .config-item label { font-weight: bold; margin-bottom: 5px; color: #555; }
        .config-item input, .config-item select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .dashboard { display: none; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .metric-icon { font-size: 2.5em; margin-bottom: 10px; }
        .metric-value { font-size: 2em; font-weight: bold; color: #667eea; margin: 10px 0; }
        .metric-label { color: #666; font-size: 0.9em; }
        .metric-detail { color: #999; font-size: 0.85em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }

        .alert-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 10px;
        }

        .alert-danger { background: #fee; color: #c33; }
        .alert-warning { background: #ffc; color: #c93; }
        .alert-success { background: #efe; color: #3c3; }
        .alert-info { background: #e3f2fd; color: #1976d2; }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .insights-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }

        .insight-title { font-weight: bold; color: #667eea; font-size: 1.1em; margin-bottom: 5px; }
        .insight-description { color: #666; line-height: 1.6; }
        .insight-recommendation { color: #2ecc71; margin-top: 10px; font-weight: bold; }

        .appliances-list { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .appliance-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }

        .appliance-time { font-weight: bold; color: #667eea; }
        .appliance-power { font-size: 1.2em; color: #333; margin: 5px 0; }
        .appliance-type { color: #666; font-style: italic; }

        .loading { text-align: center; padding: 40px; color: #667eea; font-size: 1.2em; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

        .tab {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab:hover { background: #f0f0f0; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table tr:hover { background: #f5f5f5; }

        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 20px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: white;
            font-weight: bold;
        }

        .heatmap-label {
            grid-column: 1 / -1;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }

        /* Chatbot Styles */
        .chatbot-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .chat-window {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            max-width: 80%;
        }
        .user-message {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-message {
            background: #f1f1f1;
            color: #333;
            align-self: flex-start;
        }
        .chat-input {
            display: flex;
        }
        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
        }
        .chat-input button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/arima@0.2.5/wasm/native-async.js"></script>
    <div class="container">
        <div class="header">
            <h1>‚ö° Analizador Energ√©tico Avanzado</h1>
            <p>Inteligencia artificial para optimizar tu consumo el√©ctrico</p>
        </div>

        <div class="upload-section">
            <h2>üìä Cargar datos de InfluxDB</h2>
            <p>An√°lisis profundo con machine learning y reconocimiento de patrones</p>

            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" />
                <label for="csvFile" class="file-input-label">üìÅ Seleccionar archivo CSV</label>
            </div>

            <div class="config-section">
                <div class="config-item">
                    <label>üí∞ Precio kWh (MXN)</label>
                    <input type="number" id="precioKwh" value="2.5" step="0.1" />
                </div>
                <div class="config-item">
                    <label>‚ö†Ô∏è Umbral pico (W)</label>
                    <input type="number" id="umbralPico" value="300" step="50" />
                </div>
                <div class="config-item">
                    <label>üåô Base esperada (W)</label>
                    <input type="number" id="consumoBaseEsperado" value="100" step="10" />
                </div>
                <div class="config-item">
                    <label>üìä Tarifa CFE</label>
                    <select id="tarifaCFE" onchange="refrescarAnalisisDeCostos()">
                        <option value="1">Tarifa 1 (Centro/Sur)</option>
                        <option value="1A">Tarifa 1A (Calor moderado)</option>
                        <option value="1B">Tarifa 1B (Calor medio)</option>
                        <option value="1C">Tarifa 1C (Calor alto)</option>
                        <option value="1D">Tarifa 1D (Calor muy alto)</option>
                        <option value="1E">Tarifa 1E (Calor extremo)</option>
                        <option value="1F">Tarifa 1F (Extremo + bajo cero)</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>üí∏ Presupuesto Mensual (MXN)</label>
                    <input type="number" id="presupuestoMensual" value="1000" step="100" />
                </div>
            </div>

            <div id="loading" class="loading" style="display:none;">‚è≥ Analizando datos con IA...</div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>üåç Correlaciones Contextuales</h3>
                <div class="config-item">
                    <label>üìç Ubicaci√≥n (para clima)</label>
                    <input type="text" id="location" placeholder="Ej: Ciudad de M√©xico" />
                </div>
                <div class="config-item">
                    <label>üìÖ Anotar Evento</label>
                    <input type="date" id="eventDate" />
                    <input type="text" id="eventDescription" placeholder="Ej: Vacaciones" style="margin-top: 5px;" />
                    <button onclick="addEvent()" style="margin-top: 5px; padding: 8px; background: #667eea; color: white; border: none; border-radius: 5px;">A√±adir Evento</button>
                </div>
                <div id="eventList" style="grid-column: 1 / -1;"></div>
            </div>

            <div class="config-section" style="margin-top: 30px;">
                <h3>üîÆ Simulador de Optimizaci√≥n</h3>
                <div class="config-item">
                    <label>¬øQu√© pasar√≠a si...?</label>
                    <select id="whatIfScenario" onchange="simularOptimizacion()">
                        <option value="none">Selecciona una acci√≥n</option>
                        <option value="reducirPhantom50">Reduzco fantasma 50%</option>
                        <option value="mejorarFP">Subo factor potencia a 0.95</option>
                        <option value="reprogramarPico">Muevo el pico a hora valle</option>
                        <option value="aislarCasa">Reduzco dependencia t√©rmica 30%</option>
                    </select>
                </div>
                <div id="simulationResult" class="metrics-grid" style="display:none;"></div>
            </div>
    <div style="margin-top: 20px;">
        <button onclick="generarReportePDF()" style="padding: 10px 20px; background: #c0392b; color: white; border: none; border-radius: 8px; cursor: pointer;">
            üìÑ Exportar a PDF
        </button>
        <button onclick="exportarAExcel()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer;">
            üìä Exportar a Excel
        </button>
    </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('resumen')">üìä Resumen Ejecutivo</div>
                <div class="tab" onclick="switchTab('insights')">üß† Insights IA</div>
                <div class="tab" onclick="switchTab('patrones')">üìà Patrones Avanzados</div>
                <div class="tab" onclick="switchTab('electrodomesticos')">üîå Electrodom√©sticos</div>
                <div class="tab" onclick="switchTab('comparativas')">üìä Comparativas</div>
                <div class="tab" onclick="switchTab('comparadorSemanal')">üìÖ Comparador Semanal</div>
                <div class="tab" onclick="switchTab('predicciones')">üîÆ Predicciones</div>
                <div class="tab" onclick="switchTab('analisisPredictivo')">üîé An√°lisis Predictivo</div>
                <div class="tab" onclick="switchTab('causal')">üîó An√°lisis Causal</div>
                <div class="tab" onclick="switchTab('ocupacion')">üè† Ocupaci√≥n</div>
                <div class="tab" onclick="switchTab('impacto')">üåç Impacto Ambiental</div>
                <div class="tab" onclick="switchTab('avanzado')">üî¨ Analytics Avanzados</div>
                <div class="tab" onclick="switchTab('chatbot')">ü§ñ Chatbot IA</div>
                <div class="tab" onclick="switchTab('seriesTemporales')">üï∞Ô∏è Series Temporales</div>
                <div class="tab" onclick="switchTab('alertasAparatos')">üîî Alertas y Aparatos</div>
                <div class="tab" onclick="switchTab('logros')">üèÜ Logros</div>
            </div>

            <div id="tab-resumen" class="tab-content active">
                <div class="metrics-grid" id="metricsGrid"></div>
                <div class="chart-container">
                    <h3>üéØ Mis Metas de Ahorro</h3>
                    <div id="goalSection" class="config-section" style="grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: flex-end;">
                        <div class="config-item">
                            <label for="goalPercentage">Quiero reducir un...</label>
                            <input type="number" id="goalPercentage" value="15" min="1" max="50" style="width: 80px;"/> %
                        </div>
                        <div class="config-item">
                            <label for="goalMonths">...en los pr√≥ximos...</label>
                            <input type="number" id="goalMonths" value="2" min="1" max="12"/> meses
                        </div>
                        <button onclick="setGoal()" style="padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; height: 45px;">Establecer Meta</button>
                    </div>
                    <div id="goalProgress" style="margin-top: 20px;"></div>
                </div>
                <div class="chart-container">
                    <h3>üìà L√≠nea de tiempo completa con eventos detectados</h3>
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div id="tab-insights" class="tab-content">
                <div class="insights-section">
                    <h3>üß† An√°lisis Inteligente de Consumo</h3>
                    <div id="insightsList"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üéØ Distribuci√≥n de consumo</h3>
                        <canvas id="distributionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üìä Factor de potencia en tiempo real</h3>
                        <canvas id="powerFactorTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-patrones" class="tab-content">
                <div class="chart-container">
                    <h3>üî• Mapa de calor: Consumo por hora y d√≠a</h3>
                    <div id="heatmapContainer"></div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üïê Patr√≥n circadiano (24h)</h3>
                        <canvas id="hourlyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üìÖ Patr√≥n semanal</h3>
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìä Variabilidad del consumo</h3>
                    <canvas id="variabilityChart"></canvas>
                </div>
            </div>

            <div id="tab-electrodomesticos" class="tab-content">
                <div class="metrics-grid" id="appliancesMetrics"></div>
                <div class="appliances-list">
                    <h3>üîå Top 30 eventos de encendido detectados</h3>
                    <div id="appliancesList"></div>
                </div>
            </div>

            <div id="tab-comparativas" class="tab-content">
                <div class="insights-section">
                    <h3>üìä Benchmarking y Comparativas</h3>
                    <div id="comparativesList"></div>
                </div>
                <div class="chart-container">
                    <h3>üìà Tu hogar vs. Promedio nacional</h3>
                    <canvas id="benchmarkChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>üè° Comparativa con Vecinos (Simulado)</h3>
                    <p>Compara tu consumo diario con un hogar similar en tu zona. Esto es una simulaci√≥n para fines demostrativos.</p>
                    <canvas id="neighborComparisonChart"></canvas>
                </div>
            </div>

            <div id="tab-comparadorSemanal" class="tab-content">
                <div class="chart-container">
                    <h3>üìä Comparativa Semanal: Consumo Actual vs. Semana Anterior</h3>
                    <canvas id="weeklyComparisonChart"></canvas>
                </div>
                <div class="metrics-grid" id="weeklyComparisonMetrics"></div>
            </div>

            <div id="tab-predicciones" class="tab-content">
                <div class="metrics-grid" id="predictionsMetrics"></div>
                <div class="chart-container">
                    <h3>üîÆ Proyecci√≥n de consumo y costo (30 d√≠as)</h3>
                    <canvas id="predictionChart"></canvas>
                </div>
                <div class="insights-section">
                    <h3>üí° Recomendaciones personalizadas</h3>
                    <div id="recommendationsList"></div>
                </div>
            </div>

            <div id="tab-analisisPredictivo" class="tab-content">
                <div class="insights-section" id="predictiveAnalysis">
                    <h3>üîé An√°lisis Predictivo Avanzado</h3>
                </div>
            </div>

            <div id="tab-causal" class="tab-content">
                <div class="insights-section">
                    <h3>üîó Modelo Causal de Consumo</h3>
                    <div id="causalModel"></div>
                </div>
                <div class="chart-container">
                    <h3>üéØ Impacto de Variables Externas</h3>
                    <canvas id="causalChart"></canvas>
                </div>
                <div class="metrics-grid" id="causalMetrics"></div>
            </div>

            <div id="tab-ocupacion" class="tab-content">
                <div class="metrics-grid" id="occupancyMetrics"></div>
                <div class="chart-container">
                    <h3>üóìÔ∏è Horas de Ocupaci√≥n Estimada por D√≠a</h3>
                    <canvas id="occupancyChart"></canvas>
                </div>
                <div class="insight-item">
                    <p>Este an√°lisis estima la presencia de personas en el hogar bas√°ndose en cambios abruptos de consumo. No es 100% preciso, pero ayuda a entender patrones de vida.</p>
                </div>
            </div>

            <div id="tab-impacto" class="tab-content">
                <div class="metrics-grid" id="environmentalMetrics"></div>
                <div class="chart-container">
                    <h3>Comparativa de Huella de Carbono</h3>
                    <canvas id="carbonFootprintChart"></canvas>
                </div>
            </div>

            <div id="tab-avanzado" class="tab-content">
                <div class="metrics-grid" id="advancedAnalyticsMetrics"></div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üìà Eficiencia Horaria (%)</h3>
                        <canvas id="hourlyEfficiencyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>‚ö° Rampas de Consumo (W/s)</h3>
                        <div id="rampsList" class="appliances-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="insights-section">
                    <h3>üîÑ Uso Simult√°neo de Aparatos</h3>
                    <div id="simultaneousUseList" class="appliances-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <div id="tab-chatbot" class="tab-content">
                <div class="chatbot-container">
                    <h3>ü§ñ Asistente de An√°lisis Energ√©tico</h3>
                    <div class="chat-window" id="chatWindow">
                        <div class="chat-message bot-message">Hola, soy tu asistente de energ√≠a. ¬øEn qu√© puedo ayudarte?</div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Escribe tu pregunta...">
                        <button onclick="enviarMensajeChat()">Enviar</button>
                    </div>
                </div>
            </div>

            <div id="tab-seriesTemporales" class="tab-content">
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>üìä Autocorrelaci√≥n (ACF)</h3>
                        <canvas id="acfChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>üìà An√°lisis de Frecuencias (Fourier)</h3>
                        <canvas id="fftChart"></canvas>
                    </div>
                </div>
                <div class="insights-section">
                    <p><strong>Autocorrelaci√≥n:</strong> Muestra c√≥mo el consumo de un momento se parece al de momentos pasados. Picos altos sugieren patrones repetitivos (ej. un pico cada 24 horas indica un ciclo diario).</p>
                    <p><strong>An√°lisis de Frecuencias:</strong> Descompone la se√±al de consumo en sus ciclos fundamentales. Un pico en el gr√°fico revela una frecuencia dominante (ej. un ciclo que se repite cada 8 horas).</p>
                </div>
            </div>

            <div id="tab-logros" class="tab-content">
                <div class="insights-section">
                    <h3>üèÜ Mis Logros Desbloqueados</h3>
                    <div id="logrosContainer" class="metrics-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));"></div>
                </div>
            </div>

            <div id="tab-alertasAparatos" class="tab-content">
                <div class="insights-section">
                    <h3>üîî Alertas Inteligentes</h3>
                    <div id="alertasInteligentesContainer"></div>
                </div>

                <div class="chart-container">
                    <h3>üîå Scoring de Electrodom√©sticos</h3>
                    <table class="comparison-table" id="scoringTable">
                        <thead>
                            <tr>
                                <th>Aparato (Cluster)</th>
                                <th>Potencia Promedio</th>
                                <th>Frecuencia de Uso</th>
                                <th>Costo Mensual Estimado</th>
                                <th>Score de Eficiencia</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="insights-section">
                    <h3>üí° Calculadora de Reemplazo</h3>
                    <div class="config-section" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="config-item">
                            <label for="aparatoSeleccionado">Selecciona un aparato para analizar:</label>
                            <select id="aparatoSeleccionado" onchange="actualizarCalculadoraReemplazo()"></select>
                        </div>
                        <div class="config-item">
                            <label>Costo del Aparato Nuevo (MXN)</label>
                            <input type="number" id="costoAparatoNuevo" value="15000" step="500">
                        </div>
                        <div class="config-item">
                            <label>Consumo del Aparato Nuevo (W)</label>
                            <input type="number" id="consumoAparatoNuevo" value="100" step="10">
                        </div>
                    </div>
                    <button onclick="calcularReemplazo()" style="margin-top: 20px; padding: 12px 25px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer;">Calcular Ahorro</button>
                    <div id="resultadoReemplazo" class="metrics-grid" style="margin-top: 20px;"></div>
                </div>
            </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        let chartInstances = {};
        let analyzedData = null;
        let events = JSON.parse(localStorage.getItem('events')) || [];
        let signatureLibrary = JSON.parse(localStorage.getItem('signatureLibrary')) || [];

        function guardarFirma(picoIndex, potencia) {
            const input = document.getElementById(`label-${picoIndex}`);
            const etiqueta = input.value.trim();
            if (!etiqueta) {
                alert('Por favor, introduce una etiqueta para el aparato.');
                return;
            }

            // A√±adir o actualizar la firma
            signatureLibrary.push({ etiqueta, potencia });

            // Eliminar duplicados, manteniendo el m√°s reciente
            signatureLibrary = signatureLibrary.filter((item, index, self) =>
                index === self.findIndex((t) => (
                    t.etiqueta === item.etiqueta
                ))
            );

            localStorage.setItem('signatureLibrary', JSON.stringify(signatureLibrary));
            alert(`Firma "${etiqueta}" guardada con ${potencia} W.`);
            input.value = '';

            // Re-clasificar y re-renderizar
            refrescarClasificacionAparatos();
        }

        function refrescarClasificacionAparatos() {
            analyzedData.picos.forEach(pico => {
                pico.clasificacion = clasificarAparato(pico.diff);
            });
            renderAppliancesList();
        }

        function estimateOccupancy(data) {
            const occupancy = [];
            for (let i = 1; i < data.length; i++) {
                const diff = Math.abs(data[i].power - data[i-1].power);
                if (diff > 50) {
                    occupancy.push({ time: data[i].time, occupied: 1 });
                } else {
                    occupancy.push({ time: data[i].time, occupied: 0 });
                }
            }
            return occupancy;
        }

        function addEvent() {
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;
            if (date && description) {
                events.push({ date, description });
                localStorage.setItem('events', JSON.stringify(events));
                renderEvents();
                document.getElementById('eventDate').value = '';
                document.getElementById('eventDescription').value = '';
            }
        }

        function deleteEvent(index) {
            events.splice(index, 1);
            localStorage.setItem('events', JSON.stringify(events));
            renderEvents();
        }

        function renderEvents() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = events.map((event, index) => `
                <div class="event-item" style="display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #eee;">
                    <span><strong>${event.date}:</strong> ${event.description}</span>
                    <button onclick="deleteEvent(${index})" style="background: #e74c3c; color: white; border: none; border-radius: 5px; padding: 3px 8px;">X</button>
                </div>
            `).join('');
        }

        async function fetchWeatherData(latitude, longitude, startDate, endDate) {
            const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${latitude}&longitude=${longitude}&start_date=${startDate}&end_date=${endDate}&hourly=temperature_2m,relative_humidity_2m`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Error fetching weather data:', response.statusText);
                    return null;
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching weather data:', error);
                return null;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'vista3d') {
                renderizarVista3D();
            }
            if (tabName === 'seriesTemporales') {
                renderACFChart();
                renderFFTChart();
            }
            if (tabName === 'alertasAparatos') {
                renderizarAlertasYAparatos();
            }
            if (tabName === 'logros') {
                renderizarLogros();
            }
        }

        function clasificarAparato(watts) {
            watts = Math.round(watts);

            // 1. Buscar en la biblioteca de firmas del usuario
            for (const firma of signatureLibrary) {
                const diferencia = Math.abs(watts - firma.potencia);
                const porcentajeDiferencia = (diferencia / firma.potencia) * 100;
                if (porcentajeDiferencia <= 15) { // Tolerancia del 15%
                    return { tipo: `[Usuario] ${firma.etiqueta}`, color: '#2ecc71', categoria: 'Personalizado' };
                }
            }

            // 2. Si no hay coincidencia, usar las reglas generales
            if (watts > 2500) return { tipo: 'üöø Regadera el√©ctrica / HVAC', color: '#e74c3c', categoria: 'Alto consumo' };
            if (watts > 1500) return { tipo: 'üç≥ Horno / Parrilla inducci√≥n', color: '#e67e22', categoria: 'Alto consumo' };
            if (watts > 800) return { tipo: 'üì± Microondas / Cafetera', color: '#f39c12', categoria: 'Medio consumo' };
            if (watts > 300) return { tipo: 'üëï Lavadora / Motor', color: '#3498db', categoria: 'Medio consumo' };
            if (watts > 100) return { tipo: '‚ùÑÔ∏è Refrigerador / Ventilador', color: '#1abc9c', categoria: 'Bajo consumo' };
            return { tipo: 'üíª Electr√≥nica / Iluminaci√≥n', color: '#95a5a6', categoria: 'Bajo consumo' };
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'block';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                comments: '#',
                complete: async function(results) {
                    try {
                        await procesarDatos(results.data);
                    } catch (e) {
                        console.error("Error processing data:", e);
                        alert("An error occurred during data processing. Check the console for details.");
                    } finally {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                    }
                },
                error: function(error) {
                    alert('Error: ' + error.message);
                    document.getElementById('loading').style.display = 'none';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', renderEvents);

        async function getCoordinates(location) {
            if (!location) return null;
            const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    return {
                        latitude: data.results[0].latitude,
                        longitude: data.results[0].longitude
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching coordinates:', error);
                return null;
            }
        }

        const tarifasCFE = {
            '1': {
                limiteDAC: 250, // kWh/mes
                precios: [ // [limite_kWh, precio]
                    { limite: 75, precio: 0.98 },  // B√°sico
                    { limite: 140, precio: 1.19 }, // Intermedio
                    { limite: Infinity, precio: 3.52 } // Excedente
                ]
            },
            '1A': {
                limiteDAC: 300,
                precios: [
                    { limite: 100, precio: 0.88 },
                    { limite: 200, precio: 1.08 },
                    { limite: Infinity, precio: 3.21 }
                ]
            },
            '1B': {
                limiteDAC: 400,
                precios: [
                    { limite: 125, precio: 0.88 },
                    { limite: 250, precio: 1.08 },
                    { limite: Infinity, precio: 3.21 }
                ]
            },
            '1C': {
                limiteDAC: 850,
                precios: [
                    { limite: 150, precio: 0.88 },
                    { limite: 300, precio: 1.08 },
                    { limite: Infinity, precio: 3.21 }
                ]
            },
            '1D': {
                limiteDAC: 1000,
                precios: [
                    { limite: 175, precio: 0.88 },
                    { limite: 400, precio: 1.08 },
                    { limite: Infinity, precio: 3.21 }
                ]
            },
            '1E': {
                limiteDAC: 2000,
                precios: [
                    { limite: 300, precio: 0.88 },
                    { limite: 600, precio: 1.08 },
                    { limite: Infinity, precio: 3.21 }
                ]
            },
            '1F': {
                limiteDAC: 2500,
                precios: [
                    { limite: 300, precio: 0.88 },
                    { limite: 1200, precio: 1.98 },
                    { limite: Infinity, precio: 3.21 }
                ]
            },
            'DAC': {
                limiteDAC: Infinity,
                precios: [
                    { limite: Infinity, precio: 6.38 } // Precio √∫nico
                ]
            }
        };

        function calcularCostoCFE(consumoMensualKwh, tarifaKey) {
            const tarifa = tarifasCFE[tarifaKey];
            let esDAC = consumoMensualKwh > tarifa.limiteDAC;
            const esquemaPrecios = esDAC ? tarifasCFE['DAC'].precios : tarifa.precios;

            let costo = 0;
            let consumoRestante = consumoMensualKwh;
            let limiteAnterior = 0;

            for (const nivel of esquemaPrecios) {
                const consumoEnNivel = Math.min(consumoRestante, nivel.limite - limiteAnterior);
                costo += consumoEnNivel * nivel.precio;
                consumoRestante -= consumoEnNivel;
                limiteAnterior = nivel.limite;

                if (consumoRestante <= 0) break;
            }

            return { costo, esDAC };
        }


        async function procesarDatos(data) {
            const precioKwh = parseFloat(document.getElementById('precioKwh').value); // Se mantiene como referencia
            const umbralPico = parseFloat(document.getElementById('umbralPico').value);
            const consumoBaseEsperado = parseFloat(document.getElementById('consumoBaseEsperado').value);
            const tarifaCFE = document.getElementById('tarifaCFE').value;
            const presupuestoMensual = parseFloat(document.getElementById('presupuestoMensual').value);

            const datosLimpios = data
                .filter(row => row.time && row.power && row.power_factor)
                .map(row => ({
                    time: new Date(row.time),
                    power: parseFloat(row.power),
                    powerFactor: parseFloat(row.power_factor)
                }))
                .filter(row => !isNaN(row.power) && !isNaN(row.powerFactor))
                .sort((a, b) => a.time - b.time);

            if (datosLimpios.length === 0) {
                alert('No se encontraron datos v√°lidos');
                return;
            }

            const location = document.getElementById('location').value;
            const coordinates = await getCoordinates(location);
            let weatherData = null;
            if (coordinates) {
                const startDate = datosLimpios[0].time.toISOString().slice(0, 10);
                const endDate = datosLimpios[datosLimpios.length - 1].time.toISOString().slice(0, 10);
                weatherData = await fetchWeatherData(coordinates.latitude, coordinates.longitude, startDate, endDate);
            }

            if (weatherData && weatherData.hourly) {
                const weatherMap = new Map();
                weatherData.hourly.time.forEach((t, i) => {
                    weatherMap.set(new Date(t).getTime(), {
                        temperature: weatherData.hourly.temperature_2m[i],
                        humidity: weatherData.hourly.relative_humidity_2m[i]
                    });
                });

                datosLimpios.forEach(d => {
                    const weather = weatherMap.get(d.time.getTime());
                    if (weather) {
                        d.temperature = weather.temperature;
                        d.humidity = weather.humidity;
                    }
                });
            }

            // An√°lisis estad√≠stico avanzado
            const potencias = datosLimpios.map(d => d.power);
            const consumoPromedio = potencias.reduce((a, b) => a + b, 0) / potencias.length;
            const consumoMaximo = Math.max(...potencias);
            const consumoMinimo = Math.min(...potencias);

            // Desviaci√≥n est√°ndar
            const varianza = potencias.reduce((sum, val) => sum + Math.pow(val - consumoPromedio, 2), 0) / potencias.length;
            const desviacionEstandar = Math.sqrt(varianza);

            // Percentiles
            const potenciasOrdenadas = [...potencias].sort((a, b) => a - b);
            const p25 = potenciasOrdenadas[Math.floor(potencias.length * 0.25)];
            const p50 = potenciasOrdenadas[Math.floor(potencias.length * 0.50)];
            const p75 = potenciasOrdenadas[Math.floor(potencias.length * 0.75)];
            const p95 = potenciasOrdenadas[Math.floor(potencias.length * 0.95)];

            // Consumo base
            const datosNoche = datosLimpios.filter(d => {
                const hora = d.time.getHours();
                return hora >= 2 && hora <= 4;
            });
            const consumoBase = datosNoche.length > 0
                ? datosNoche.reduce((a, b) => a + b.power, 0) / datosNoche.length
                : p25;

            // Factor de potencia
            const fpDatos = datosLimpios.filter(d => d.power > 20);
            const factorPotenciaPromedio = fpDatos.reduce((a, b) => a + b.powerFactor, 0) / fpDatos.length;
            const fpMinimo = Math.min(...fpDatos.map(d => d.powerFactor));

            // Detecci√≥n de picos
            const picos = [];
            for (let i = 1; i < datosLimpios.length; i++) {
                const diff = datosLimpios[i].power - datosLimpios[i-1].power;
                if (diff > umbralPico) {
                    picos.push({
                        time: datosLimpios[i].time,
                        power: datosLimpios[i].power,
                        diff: diff,
                        clasificacion: clasificarAparato(diff)
                    });
                }
            }
            picos.sort((a, b) => b.diff - a.diff);

            // Conteo por categor√≠a
            const categorias = {};
            picos.forEach(p => {
                const cat = p.clasificacion.categoria;
                categorias[cat] = (categorias[cat] || 0) + 1;
            });

            // Patr√≥n por hora (con desviaci√≥n)
            const consumoPorHora = Array(24).fill(0).map(() => []);
            datosLimpios.forEach(d => {
                consumoPorHora[d.time.getHours()].push(d.power);
            });
            const promedioPorHora = consumoPorHora.map(arr =>
                arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0
            );
            const desviacionPorHora = consumoPorHora.map(arr => {
                if (arr.length < 2) return 0;
                const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
                const variance = arr.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / arr.length;
                return Math.sqrt(variance);
            });

            // Patr√≥n por d√≠a de la semana
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            const consumoPorDia = Array(7).fill(0).map(() => []);
            datosLimpios.forEach(d => {
                consumoPorDia[d.time.getDay()].push(d.power);
            });
            const promedioPorDia = consumoPorDia.map(arr =>
                arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0
            );

            // Mapa de calor (d√≠a x hora)
            const mapaCalor = Array(7).fill(0).map(() => Array(24).fill(0).map(() => []));
            datosLimpios.forEach(d => {
                mapaCalor[d.time.getDay()][d.time.getHours()].push(d.power);
            });
            const mapaCalorPromedio = mapaCalor.map(dia =>
                dia.map(hora => hora.length > 0 ? hora.reduce((a,b) => a+b, 0) / hora.length : 0)
            );

            // Costos
            const diasDatos = (datosLimpios[datosLimpios.length - 1].time - datosLimpios[0].time) / (1000 * 60 * 60 * 24);
            const tuConsumoMensual = (consumoPromedio * 24 * 30.5) / 1000;
            const kwhTotal = (consumoPromedio * 24 * diasDatos) / 1000;

            const { costo: costoMes, esDAC: esTarifaDAC } = calcularCostoCFE(tuConsumoMensual, tarifaCFE);
            const costoTotal = (costoMes / 30.5) * diasDatos;
            const costoFantasmaMes = (consumoBase / consumoPromedio) * costoMes;
            const ahorroMensualPotencial = ((consumoBase - consumoBaseEsperado) / consumoPromedio) * costoMes;


            // Proyecciones
            const tendencia = calcularTendencia(datosLimpios);
            const consumoProyectado30d = consumoPromedio * (1 + tendencia * 30);
            const costoProyectado30d = (consumoProyectado30d * 24 * 30) / 1000 * precioKwh;

            // ---- ANALYTICS AVANZADOS ----

            // 1. Factor de Carga
            const factorCarga = consumoPromedio / consumoMaximo;

            // 2. An√°lisis de Rampas
            const rampas = [];
            for (let i = 1; i < datosLimpios.length; i++) {
                const diffTiempo = (datosLimpios[i].time - datosLimpios[i-1].time) / 1000; // segundos
                if (diffTiempo > 0) {
                    const diffPotencia = datosLimpios[i].power - datosLimpios[i-1].power;
                    const velocidad = diffPotencia / diffTiempo; // W/s
                    if (Math.abs(velocidad) > 500) { // Umbral para rampas significativas
                        rampas.push({
                            time: datosLimpios[i].time,
                            velocidad: velocidad,
                            tipo: velocidad > 0 ? 'Subida' : 'Bajada'
                        });
                    }
                }
            }

            // 3. Matriz de Uso Simult√°neo (simplificado)
            const usoSimultaneo = [];
            const ventanaMinutos = 5;
            for (let i = 0; i < picos.length; i++) {
                for (let j = i + 1; j < picos.length; j++) {
                    const diffTiempo = Math.abs(picos[i].time - picos[j].time) / (1000 * 60);
                    if (diffTiempo < ventanaMinutos) {
                        usoSimultaneo.push({
                            time: picos[i].time,
                            aparato1: picos[i].clasificacion.tipo,
                            aparato2: picos[j].clasificacion.tipo,
                            potenciaTotal: picos[i].diff + picos[j].diff
                        });
                    }
                }
            }

            // 4. Eficiencia Horaria
            const eficienciaHoraria = promedioPorHora.map((consumoHora, hora) => {
                if (consumoHora === 0) return 0;
                const consumoProductivo = consumoHora - consumoBase;
                const eficiencia = (consumoProductivo / consumoHora) * 100;
                return Math.max(0, eficiencia); // No puede ser negativo
            });


            // Benchmarking (datos aproximados de M√©xico)
            const promedioNacionalMensual = 300; // kWh
            const comparativoNacional = ((tuConsumoMensual - promedioNacionalMensual) / promedioNacionalMensual) * 100;

            analyzedData = {
                datosLimpios, consumoPromedio, consumoMaximo, consumoMinimo,
                desviacionEstandar, p25, p50, p75, p95,
                consumoBase, factorPotenciaPromedio, fpMinimo,
                picos, categorias,
                promedioPorHora, desviacionPorHora,
                promedioPorDia, diasSemana,
                mapaCalorPromedio,
                diasDatos, kwhTotal, costoTotal, costoMes, esTarifaDAC,
                costoFantasmaMes, ahorroMensualPotencial,
                tendencia, consumoProyectado30d, costoProyectado30d,
                tuConsumoMensual, promedioNacionalMensual, comparativoNacional,
                precioKwh, tarifaCFE, presupuestoMensual,
                // Nuevos datos
                factorCarga, rampas, usoSimultaneo, eficienciaHoraria
            };

            refrescarAnalisisDeCostos(); // Call the new function to perform the initial render

            const componentes = calcularComponentesTemporales(datosLimpios);
            analyzedData.scoreEficiencia = calcularScoreEficiencia();
            analyzedData.clusters = clusterizarDispositivos();
            analyzedData.desgaste = analizarDesgaste();
            analyzedData.deteccionAnomalias = componentes.residuales;
            analyzedData.occupancy = estimateOccupancy(datosLimpios);
            analyzedData.acf = calcularACF(potencias, 48); // Autocorrelaci√≥n para 48 retardos (asumiendo datos horarios)

            let potenciasParaFFT = potencias.slice(0, 1024);
            if (potenciasParaFFT.length > 1) {
                const powerOfTwoLen = Math.pow(2, Math.floor(Math.log2(potenciasParaFFT.length)));
                potenciasParaFFT = potenciasParaFFT.slice(0, powerOfTwoLen);
                analyzedData.fft = calcularFFT(potenciasParaFFT);
            } else {
                analyzedData.fft = [];
            }


            renderizarDashboard();
            const anomalias = detectarAnomalias(analyzedData.datosLimpios);
            const anomaliasIQR = detectarAnomaliasIQR(analyzedData.datosLimpios);
            let predicciones = [];
            try {
                predicciones = await pronosticoARIMA(analyzedData.datosLimpios);
            } catch (e) {
                console.error("Error running ARIMA forecast:", e);
            }
            const clusters = clusterizarElectrodomesticos(analyzedData.picos);
            renderizarAnalisisPredictivo(anomalias, predicciones, clusters, anomaliasIQR);
        }

        function refrescarAnalisisDeCostos() {
            if (!analyzedData) return;

            const tarifaCFE = document.getElementById('tarifaCFE').value;
            const { costo: costoMes, esDAC: esTarifaDAC } = calcularCostoCFE(analyzedData.tuConsumoMensual, tarifaCFE);

            analyzedData.costoMes = costoMes;
            analyzedData.esTarifaDAC = esTarifaDAC;
            analyzedData.tarifaCFE = tarifaCFE;

            renderMetricsGrid();
        }

        function detectarAnomalias(datos, umbral = 3) {
            const potencias = datos.map(d => d.power);
            const promedio = potencias.reduce((a, b) => a + b, 0) / potencias.length;
            const desviacionEstandar = Math.sqrt(
                potencias.map(p => Math.pow(p - promedio, 2)).reduce((a, b) => a + b, 0) / potencias.length
            );

            return datos.filter(d => {
                const zScore = (d.power - promedio) / desviacionEstandar;
                return Math.abs(zScore) > umbral;
            });
        }

        function detectarAnomaliasIQR(datos) {
            const potencias = datos.map(d => d.power).sort((a, b) => a - b);
            const q1 = potencias[Math.floor(potencias.length * 0.25)];
            const q3 = potencias[Math.floor(potencias.length * 0.75)];
            const iqr = q3 - q1;
            const limiteSuperior = q3 + 1.5 * iqr;
            const limiteInferior = q1 - 1.5 * iqr;

            return datos.filter(d => d.power > limiteSuperior || d.power < limiteInferior);
        }

        function renderNeighborComparison() {
            const d = analyzedData;
            const ctx = document.getElementById('neighborComparisonChart').getContext('2d');
            if (chartInstances.neighbor) chartInstances.neighbor.destroy();

            // Simulate neighbor's data
            const neighborData = d.promedioPorHora.map(consumo => {
                const factor = 0.8 + Math.random() * 0.4; // between 0.8 and 1.2
                return consumo * factor;
            });

            chartInstances.neighbor = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [
                        {
                            label: 'Tu Consumo Promedio',
                            data: d.promedioPorHora,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Consumo del Vecino (Simulado)',
                            data: neighborData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Consumo Promedio (W)' } } }
                }
            });
        }

        function calcularTendencia(datos) {
            const n = Math.min(datos.length, 1000);
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += datos[i].power;
                sumXY += i * datos[i].power;
                sumX2 += i * i;
            }

            const pendiente = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            return pendiente / datos[0].power;
        }

        function renderizarDashboard() {
            renderMetricsGrid();
            renderInsights();
            renderMainChart();
            renderDistributionChart();
            renderPowerFactorTimeChart();
            renderHeatmap();
            renderHourlyChart();
            renderWeeklyChart();
            renderVariabilityChart();
            renderAppliancesMetrics();
            renderAppliancesList();
            renderComparatives();
            renderBenchmarkChart();
            renderNeighborComparison();
            renderizarComparadorSemanal();
            renderPredictionsMetrics();
            renderPredictionChart();
            renderRecommendations();
            renderCausalAnalysis();
            renderOccupancyMetrics();
            renderOccupancyChart();
            renderEnvironmentalImpact();
            renderizarAdvancedAnalytics();

            document.getElementById('insightsList').innerHTML += generarDiagnosticoNLP();
            renderGoalProgress();
        }

        function setGoal() {
            const percentage = document.getElementById('goalPercentage').value;
            const months = document.getElementById('goalMonths').value;
            if (percentage && months) {
                const goal = {
                    percentage: parseFloat(percentage),
                    months: parseInt(months),
                    startDate: new Date().toISOString(),
                    initialConsumption: analyzedData.tuConsumoMensual
                };
                localStorage.setItem('userGoal', JSON.stringify(goal));
                renderGoalProgress();
            }
        }

        function renderGoalProgress() {
            const goal = JSON.parse(localStorage.getItem('userGoal'));
            const progressContainer = document.getElementById('goalProgress');

            if (!goal) {
                progressContainer.innerHTML = '<p>No has establecido una meta de ahorro. ¬°Define una para empezar a medir tu progreso!</p>';
                return;
            }

            const targetConsumption = goal.initialConsumption * (1 - goal.percentage / 100);
            const currentConsumption = analyzedData.tuConsumoMensual;
            const progress = ((goal.initialConsumption - currentConsumption) / (goal.initialConsumption - targetConsumption)) * 100;

            const startDate = new Date(goal.startDate);
            const endDate = new Date(startDate);
            endDate.setMonth(startDate.getMonth() + goal.months);
            const daysRemaining = Math.max(0, Math.round((endDate - new Date()) / (1000 * 60 * 60 * 24)));

            progressContainer.innerHTML = `
                <div class="insight-item" style="border-left-color: #2ecc71;">
                    <div class="insight-title">Meta Actual: Reducir ${goal.percentage}% en ${goal.months} meses</div>
                    <p><strong>Consumo Inicial:</strong> ${goal.initialConsumption.toFixed(0)} kWh/mes</p>
                    <p><strong>Consumo Objetivo:</strong> ${targetConsumption.toFixed(0)} kWh/mes</p>
                    <p><strong>Consumo Actual:</strong> ${currentConsumption.toFixed(0)} kWh/mes</p>
                    <div style="background: #eee; border-radius: 10px; padding: 2px; margin-top: 10px;">
                        <div style="width: ${Math.min(100, Math.max(0, progress)).toFixed(1)}%; background: linear-gradient(90deg, #2ecc71, #27ae60); color: white; text-align: center; padding: 5px; border-radius: 8px;">
                            ${progress.toFixed(1)}%
                        </div>
                    </div>
                    <p style="margin-top: 10px;"><strong>Tiempo restante:</strong> ${daysRemaining} d√≠as</p>
                </div>
            `;
        }


        function renderMetricsGrid() {
            const d = analyzedData;
            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-label">Consumo Promedio</div>
                    <div class="metric-value">${d.consumoPromedio.toFixed(0)} W</div>
                    <div class="metric-detail">
                        Mediana: ${d.p50.toFixed(0)} W<br>
                        Desv. Std: ¬±${d.desviacionEstandar.toFixed(0)} W
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Costo Mensual (Simulado)</div>
                    <div class="metric-value">$${d.costoMes.toFixed(2)}</div>
                    <div class="metric-detail">
                        ${d.tuConsumoMensual.toFixed(0)} kWh/mes
                        ${d.esTarifaDAC ? '<br><span class="alert-badge alert-danger">‚ö†Ô∏è TARIFA DAC</span>' : '<br><span class="alert-badge alert-success">‚úì Tarifa Subsidiada</span>'}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üåô</div>
                    <div class="metric-label">Consumo Fantasma</div>
                    <div class="metric-value">${d.consumoBase.toFixed(0)} W</div>
                    <div class="metric-detail">
                        $${d.costoFantasmaMes.toFixed(2)}/mes
                        ${d.consumoBase > 150 ? '<br><span class="alert-badge alert-danger">‚ö†Ô∏è Muy alto</span>' :
                          d.consumoBase > 100 ? '<br><span class="alert-badge alert-warning">‚ö†Ô∏è Alto</span>' :
                          '<br><span class="alert-badge alert-success">‚úì √ìptimo</span>'}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-label">Factor de Potencia</div>
                    <div class="metric-value">${d.factorPotenciaPromedio.toFixed(3)}</div>
                    <div class="metric-detail">
                        M√≠nimo: ${d.fpMinimo.toFixed(3)}<br>
                        ${d.factorPotenciaPromedio < 0.8 ? '<span class="alert-badge alert-danger">‚ö†Ô∏è Muy bajo</span>' :
                          d.factorPotenciaPromedio < 0.9 ? '<span class="alert-badge alert-warning">‚ö†Ô∏è Regular</span>' :
                          '<span class="alert-badge alert-success">‚úì Excelente</span>'}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üéØ</div>
                    <div class="metric-label">Picos Detectados</div>
                    <div class="metric-value">${d.picos.length}</div>
                    <div class="metric-detail">
                        Alto consumo: ${d.categorias['Alto consumo'] || 0}<br>
                        Medio: ${d.categorias['Medio consumo'] || 0}<br>
                        Bajo: ${d.categorias['Bajo consumo'] || 0}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-label">Tendencia</div>
                    <div class="metric-value">${(d.tendencia * 100).toFixed(2)}%</div>
                    <div class="metric-detail">
                        ${d.tendencia > 0 ? 'üìà Incrementando' : 'üìâ Disminuyendo'}<br>
                        ${Math.abs(d.tendencia * 100).toFixed(2)}% por d√≠a
                    </div>
                </div>
            `;
        }

        function renderInsights() {
            const d = analyzedData;
            let insights = [];

            // Insight 1: Consumo fantasma
            if (d.consumoBase > 150) {
                insights.push({
                    icon: 'üåô',
                    title: 'Consumo fantasma cr√≠tico detectado',
                    description: `Tu hogar consume ${d.consumoBase.toFixed(0)}W cuando "no usas nada". Esto representa el ${((d.consumoBase/d.consumoPromedio)*100).toFixed(1)}% de tu consumo promedio y te cuesta ${d.costoFantasmaMes.toFixed(2)} MXN al mes.`,
                    recommendation: `üí° Recomendaci√≥n: Desconecta cargadores, apaga regletas, considera smart plugs. Ahorro potencial: ${d.ahorroMensualPotencial.toFixed(2)} MXN/mes`
                });
            }

            // Insight 2: Factor de potencia
            if (d.factorPotenciaPromedio < 0.85) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    title: 'Equipos ineficientes detectados',
                    description: `Tu factor de potencia promedio es ${d.factorPotenciaPromedio.toFixed(3)} (ideal >0.9). Esto indica equipos de mala calidad, cargadores gen√©ricos o motores viejos que desperdician energ√≠a.`,
                    recommendation: `üí° Recomendaci√≥n: Reemplaza cargadores baratos, considera actualizar electrodom√©sticos viejos. Mejora potencial: 10-15% en eficiencia.`
                });
            }

            // Insight 3: Variabilidad
            const cv = (d.desviacionEstandar / d.consumoPromedio) * 100;
            if (cv > 50) {
                insights.push({
                    icon: 'üìä',
                    title: 'Alta variabilidad en consumo',
                    description: `Tu consumo var√≠a significativamente (CV: ${cv.toFixed(1)}%). Esto sugiere uso irregular de electrodom√©sticos de alto consumo o picos frecuentes.`,
                    recommendation: `üí° Recomendaci√≥n: Programa electrodom√©sticos grandes en horarios valle, evita usar m√∫ltiples aparatos simult√°neamente.`
                });
            }

            // Insight 4: Hora pico
            const horaPico = d.promedioPorHora.indexOf(Math.max(...d.promedioPorHora));
            const consumoHoraPico = d.promedioPorHora[horaPico];
            if (consumoHoraPico > d.consumoPromedio * 1.5) {
                insights.push({
                    icon: 'üïê',
                    title: `Pico de consumo a las ${horaPico}:00 hrs`,
                    description: `Entre las ${horaPico}:00-${horaPico+1}:00 tu consumo promedio es ${consumoHoraPico.toFixed(0)}W, un ${(((consumoHoraPico/d.consumoPromedio)-1)*100).toFixed(0)}% m√°s alto que tu promedio diario.`,
                    recommendation: `üí° Recomendaci√≥n: Identifica qu√© aparatos usas a esta hora y considera reprogramarlos a horarios de menor consumo.`
                });
            }

            // Insight 5: Comparativo nacional
            if (d.comparativoNacional > 20) {
                insights.push({
                    icon: 'üìä',
                    title: 'Consumo por encima del promedio nacional',
                    description: `Tu consumo mensual (${d.tuConsumoMensual.toFixed(0)} kWh) es ${Math.abs(d.comparativoNacional).toFixed(0)}% mayor que el promedio nacional mexicano (${d.promedioNacionalMensual} kWh/mes).`,
                    recommendation: `üí° Recomendaci√≥n: Revisa la secci√≥n de Electrodom√©sticos para identificar equipos que consumen m√°s de lo normal.`
                });
            } else if (d.comparativoNacional < -20) {
                insights.push({
                    icon: 'üåü',
                    title: '¬°Consumo eficiente!',
                    description: `Felicidades, tu consumo est√° ${Math.abs(d.comparativoNacional).toFixed(0)}% por debajo del promedio nacional. Esto indica buenos h√°bitos de ahorro energ√©tico.`,
                    recommendation: `üí° Sigue as√≠: Mant√©n estos h√°bitos y comparte tus tips con familiares.`
                });
            }

            // Insight 6: Proyecci√≥n
            if (Math.abs(d.tendencia) > 0.01) {
                const direccion = d.tendencia > 0 ? 'incrementar√°' : 'disminuir√°';
                insights.push({
                    icon: 'üîÆ',
                    title: `Tu consumo ${direccion} en los pr√≥ximos d√≠as`,
                    description: `Basado en la tendencia actual (${(d.tendencia*100).toFixed(2)}%/d√≠a), se proyecta que en 30 d√≠as tu consumo ser√° de ${d.consumoProyectado30d.toFixed(0)}W promedio, con un costo de ${d.costoProyectado30d.toFixed(2)} MXN.`,
                    recommendation: d.tendencia > 0 ?
                        `‚ö†Ô∏è Alerta: Tu consumo est√° aumentando. Revisa qu√© ha cambiado recientemente (nuevo equipo, m√°s uso de AC, etc.)` :
                        `‚úÖ Excelente: Tu consumo est√° bajando. ¬°Sigue con esos buenos h√°bitos!`
                });
            }

            const html = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.icon} ${insight.title}</div>
                    <div class="insight-description">${insight.description}</div>
                    <div class="insight-recommendation">${insight.recommendation}</div>
                </div>
            `).join('');

            document.getElementById('insightsList').innerHTML = html || '<p>No hay insights cr√≠ticos. Tu consumo parece normal.</p>';
        }

        function renderMainChart() {
            const d = analyzedData;
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstances.main) chartInstances.main.destroy();

            const agrupado = {};
            d.datosLimpios.forEach(dato => {
                const key = dato.time.toISOString().slice(0, 13) + ':00:00';
                if (!agrupado[key]) agrupado[key] = [];
                agrupado[key].push(dato.power);
            });

            const labels = Object.keys(agrupado).sort();
            const valores = labels.map(k => agrupado[k].reduce((a,b) => a+b, 0) / agrupado[k].length);

            const eventAnnotations = events.map(event => {
                return {
                    type: 'line',
                    mode: 'vertical',
                    scaleID: 'x',
                    value: new Date(event.date).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' }),
                    borderColor: 'red',
                    borderWidth: 2,
                    label: {
                        content: event.description,
                        enabled: true,
                        position: 'top'
                    }
                }
            });

            chartInstances.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => new Date(l).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' })),
                    datasets: [{
                        label: 'Consumo Real (W)',
                        data: valores,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Consumo Base',
                        data: Array(labels.length).fill(d.consumoBase),
                        borderColor: '#e74c3c',
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'Promedio',
                        data: Array(labels.length).fill(d.consumoPromedio),
                        borderColor: '#2ecc71',
                        borderDash: [2, 2],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        annotation: {
                            annotations: eventAnnotations
                        }
                    },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Watts' } } }
                }
            });
        }

        function renderDistributionChart() {
            const d = analyzedData;
            const ctx = document.getElementById('distributionChart').getContext('2d');
            if (chartInstances.dist) chartInstances.dist.destroy();

            chartInstances.dist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['M√≠nimo', 'P25', 'Mediana', 'Promedio', 'P75', 'P95', 'M√°ximo'],
                    datasets: [{
                        label: 'Distribuci√≥n (W)',
                        data: [d.consumoMinimo, d.p25, d.p50, d.consumoPromedio, d.p75, d.p95, d.consumoMaximo],
                        backgroundColor: ['#95a5a6', '#3498db', '#1abc9c', '#2ecc71', '#f39c12', '#e67e22', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderPowerFactorTimeChart() {
            const d = analyzedData;
            const ctx = document.getElementById('powerFactorTimeChart').getContext('2d');
            if (chartInstances.pftime) chartInstances.pftime.destroy();

            const muestras = d.datosLimpios.filter((_, i) => i % 100 === 0).slice(0, 100);

            chartInstances.pftime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: muestras.map(m => m.time.toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit' })),
                    datasets: [{
                        label: 'Factor de Potencia',
                        data: muestras.map(m => m.powerFactor),
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Umbral √≥ptimo (0.9)',
                        data: Array(muestras.length).fill(0.9),
                        borderColor: '#2ecc71',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { min: 0, max: 1 } }
                }
            });
        }

        function renderHeatmap() {
            const d = analyzedData;
            let html = '<div class="heatmap-label">Consumo promedio por d√≠a y hora (W)</div>';

            const maxVal = Math.max(...d.mapaCalorPromedio.flat());

            d.diasSemana.forEach((dia, i) => {
                html += `<div style="grid-column: 1/-1; font-weight: bold; margin-top: 10px;">${dia}</div>`;
                d.mapaCalorPromedio[i].forEach((val, h) => {
                    const intensity = val / maxVal;
                    const color = `rgb(${Math.round(230-intensity*130)}, ${Math.round(126-intensity*50)}, ${Math.round(234-intensity*134)})`;
                    html += `<div class="heatmap-cell" style="background: ${color}" title="${dia} ${h}:00 - ${val.toFixed(0)}W">${h}</div>`;
                });
            });

            document.getElementById('heatmapContainer').innerHTML = html;
        }

        function renderHourlyChart() {
            const d = analyzedData;
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (chartInstances.hourly) chartInstances.hourly.destroy();

            chartInstances.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Promedio (W)',
                        data: d.promedioPorHora,
                        backgroundColor: d.promedioPorHora.map(v =>
                            v > d.consumoPromedio * 1.3 ? '#e74c3c' :
                            v > d.consumoPromedio ? '#f39c12' :
                            v < d.consumoPromedio * 0.5 ? '#2ecc71' : '#667eea'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderWeeklyChart() {
            const d = analyzedData;
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if (chartInstances.weekly) chartInstances.weekly.destroy();

            chartInstances.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: d.diasSemana,
                    datasets: [{
                        label: 'Promedio (W)',
                        data: d.promedioPorDia,
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderVariabilityChart() {
            const d = analyzedData;
            const ctx = document.getElementById('variabilityChart').getContext('2d');
            if (chartInstances.var) chartInstances.var.destroy();

            chartInstances.var = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'Promedio',
                        data: d.promedioPorHora,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        type: 'bar'
                    }, {
                        label: 'Variabilidad (¬±1œÉ)',
                        data: d.desviacionPorHora,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        type: 'line',
                        fill: true
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderAppliancesMetrics() {
            const d = analyzedData;
            const topPico = d.picos[0];
            const consumoAparatos = d.picos.reduce((sum, p) => sum + p.diff, 0) / d.picos.length;

            document.getElementById('appliancesMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">üîå</div>
                    <div class="metric-label">Mayor Pico Detectado</div>
                    <div class="metric-value">${topPico ? topPico.diff.toFixed(0) : 0} W</div>
                    <div class="metric-detail">
                        ${topPico ? topPico.clasificacion.tipo : 'N/A'}<br>
                        ${topPico ? topPico.time.toLocaleString('es-MX') : ''}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-label">Pico Promedio</div>
                    <div class="metric-value">${consumoAparatos.toFixed(0)} W</div>
                    <div class="metric-detail">
                        ${d.picos.length} eventos detectados<br>
                        en ${d.diasDatos.toFixed(1)} d√≠as
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-label">Frecuencia de Uso</div>
                    <div class="metric-value">${(d.picos.length / d.diasDatos).toFixed(1)}</div>
                    <div class="metric-detail">
                        Encendidos por d√≠a<br>
                        ${((d.picos.length / d.diasDatos) * 30).toFixed(0)} veces/mes
                    </div>
                </div>
            `;
        }

        function renderAppliancesList() {
            const d = analyzedData;
            const html = d.picos.slice(0, 30).map((pico, i) => `
                <div class="appliance-item" style="border-left-color: ${pico.clasificacion.color}">
                    <div class="appliance-time">${i + 1}. ${pico.time.toLocaleString('es-MX')}</div>
                    <div class="appliance-power">‚ö° Pico de ${pico.diff.toFixed(0)} W (Total: ${pico.power.toFixed(0)} W)</div>
                    <div class="appliance-type">Estimaci√≥n: <strong>${pico.clasificacion.tipo}</strong></div>
                    <div class="config-item" style="margin-top: 10px; display: flex; gap: 10px;">
                        <input type="text" id="label-${i}" placeholder="Etiqueta personalizada (ej. Cafetera)" style="flex-grow: 1;">
                        <button onclick="guardarFirma(${i}, ${pico.diff.toFixed(0)})" style="padding: 8px 12px; background: #2ecc71; color: white; border: none; border-radius: 5px;">Guardar Firma</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('appliancesList').innerHTML = html || '<p>No se detectaron picos significativos</p>';
        }

        function renderComparatives() {
            const d = analyzedData;

            const html = `
                <table class="comparison-table">
                    <tr>
                        <th>M√©trica</th>
                        <th>Tu Hogar</th>
                        <th>Promedio Nacional</th>
                        <th>Diferencia</th>
                    </tr>
                    <tr>
                        <td>Consumo Mensual</td>
                        <td>${d.tuConsumoMensual.toFixed(0)} kWh</td>
                        <td>${d.promedioNacionalMensual} kWh</td>
                        <td style="color: ${d.comparativoNacional > 0 ? '#e74c3c' : '#2ecc71'}">${d.comparativoNacional > 0 ? '+' : ''}${d.comparativoNacional.toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>Costo Mensual</td>
                        <td>${d.costoMes.toFixed(2)} MXN</td>
                        <td>${(d.promedioNacionalMensual * d.precioKwh).toFixed(2)} MXN</td>
                        <td style="color: ${d.costoMes > d.promedioNacionalMensual * d.precioKwh ? '#e74c3c' : '#2ecc71'}">
                            ${d.costoMes > d.promedioNacionalMensual * d.precioKwh ? '+' : ''}${(d.costoMes - d.promedioNacionalMensual * d.precioKwh).toFixed(2)}
                        </td>
                    </tr>
                    <tr>
                        <td>Consumo Base</td>
                        <td>${d.consumoBase.toFixed(0)} W</td>
                        <td>80-120 W (ideal)</td>
                        <td>${d.consumoBase > 120 ? '<span class="alert-badge alert-warning">Alto</span>' : '<span class="alert-badge alert-success">√ìptimo</span>'}</td>
                    </tr>
                    <tr>
                        <td>Factor de Potencia</td>
                        <td>${d.factorPotenciaPromedio.toFixed(3)}</td>
                        <td>>0.90 (ideal)</td>
                        <td>${d.factorPotenciaPromedio < 0.9 ? '<span class="alert-badge alert-warning">Mejorar</span>' : '<span class="alert-badge alert-success">Excelente</span>'}</td>
                    </tr>
                </table>
            `;

            document.getElementById('comparativesList').innerHTML = html;
        }

        function renderBenchmarkChart() {
            const d = analyzedData;
            const ctx = document.getElementById('benchmarkChart').getContext('2d');
            if (chartInstances.bench) chartInstances.bench.destroy();

            chartInstances.bench = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Tu Hogar', 'Promedio Nacional', 'Hogar Eficiente', 'Hogar Ineficiente'],
                    datasets: [{
                        label: 'Consumo Mensual (kWh)',
                        data: [d.tuConsumoMensual, d.promedioNacionalMensual, 200, 500],
                        backgroundColor: ['#667eea', '#95a5a6', '#2ecc71', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'kWh/mes' } } }
                }
            });
        }

        function renderPredictionsMetrics() {
            const d = analyzedData;
            const cambio = d.consumoProyectado30d - d.consumoPromedio;

            document.getElementById('predictionsMetrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-icon">üîÆ</div>
                    <div class="metric-label">Consumo Proyectado (30d)</div>
                    <div class="metric-value">${d.consumoProyectado30d.toFixed(0)} W</div>
                    <div class="metric-detail">
                        Cambio: ${cambio > 0 ? '+' : ''}${cambio.toFixed(0)} W<br>
                        ${Math.abs((cambio/d.consumoPromedio)*100).toFixed(1)}% vs actual
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Costo Proyectado (30d)</div>
                    <div class="metric-value">${d.costoProyectado30d.toFixed(2)}</div>
                    <div class="metric-detail">
                        Diferencia: ${(d.costoProyectado30d - d.costoMes).toFixed(2)}<br>
                        ${((d.costoProyectado30d/d.costoMes - 1)*100).toFixed(1)}% vs actual
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-label">Tasa de Crecimiento</div>
                    <div class="metric-value">${(d.tendencia * 100).toFixed(3)}%</div>
                    <div class="metric-detail">
                        Por d√≠a<br>
                        ${d.tendencia > 0 ? '‚ö†Ô∏è Consumo aumentando' : '‚úÖ Consumo disminuyendo'}
                    </div>
                </div>
            `;
        }

        function renderPredictionChart() {
            const d = analyzedData;
            const ctx = document.getElementById('predictionChart').getContext('2d');
            if (chartInstances.pred) chartInstances.pred.destroy();

            const dias = Array.from({length: 31}, (_, i) => i);
            const proyeccion = dias.map(dia => d.consumoPromedio * (1 + d.tendencia * dia));
            const costoProyeccion = proyeccion.map(consumo => (consumo * 24 / 1000) * d.precioKwh);

            chartInstances.pred = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dias.map(d => `D√≠a ${d}`),
                    datasets: [{
                        label: 'Consumo Proyectado (W)',
                        data: proyeccion,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'Costo Diario Proyectado (MXN)',
                        data: costoProyeccion,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Watts' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'MXN' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function renderRecommendations() {
            const d = analyzedData;
            let recomendaciones = [];

            if (d.ahorroMensual > 50) {
                recomendaciones.push({
                    prioridad: 'ALTA',
                    titulo: 'Eliminar consumo fantasma',
                    descripcion: 'Usa regletas con interruptor, desconecta cargadores',
                    ahorro: `${d.ahorroMensual.toFixed(2)} MXN/mes`,
                    dificultad: 'F√°cil'
                });
            }

            if (d.factorPotenciaPromedio < 0.85) {
                recomendaciones.push({
                    prioridad: 'ALTA',
                    titulo: 'Reemplazar equipos ineficientes',
                    descripcion: 'Cambia cargadores gen√©ricos por originales, actualiza electrodom√©sticos viejos',
                    ahorro: '10-15% en eficiencia',
                    dificultad: 'Media'
                });
            }

            const horaPico = d.promedioPorHora.indexOf(Math.max(...d.promedioPorHora));
            if (d.promedioPorHora[horaPico] > d.consumoPromedio * 1.5) {
                recomendaciones.push({
                    prioridad: 'MEDIA',
                    titulo: `Reprogramar uso de aparatos (${horaPico}:00 hrs)`,
                    descripcion: 'Evita usar lavadora, secadora o AC simult√°neamente',
                    ahorro: 'Reduce picos de demanda',
                    dificultad: 'F√°cil'
                });
            }

            if (d.picos.length > 20) {
                recomendaciones.push({
                    prioridad: 'BAJA',
                    titulo: 'Optimizar ciclos de uso',
                    descripcion: 'Agrupa tareas que requieran los mismos aparatos',
                    ahorro: '5-10% en eficiencia',
                    dificultad: 'F√°cil'
                });
            }

            recomendaciones.push({
                prioridad: 'INFO',
                titulo: 'Monitoreo continuo',
                descripcion: 'Revisa este dashboard semanalmente para detectar cambios',
                ahorro: 'Prevenci√≥n de aumentos',
                dificultad: 'Muy f√°cil'
            });

            const html = recomendaciones.map(rec => {
                const colorPrioridad = rec.prioridad === 'ALTA' ? 'alert-danger' :
                                       rec.prioridad === 'MEDIA' ? 'alert-warning' :
                                       rec.prioridad === 'BAJA' ? 'alert-info' : 'alert-success';
                return `
                    <div class="insight-item">
                        <div class="insight-title">
                            <span class="alert-badge ${colorPrioridad}">${rec.prioridad}</span>
                            ${rec.titulo}
                        </div>
                        <div class="insight-description">
                            ${rec.descripcion}<br>
                            <strong>Ahorro potencial:</strong> ${rec.ahorro}<br>
                            <strong>Dificultad:</strong> ${rec.dificultad}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recommendationsList').innerHTML = html;
        }

// An√°lisis de descomposici√≥n de series temporales (STL-like)
function calcularComponentesTemporales(datos) {
    // Extrae tendencia, estacionalidad y residual
    const ventana = 24; // 24 horas para suavizado
    const suavizado = datos.map((_, i) => {
        const inicio = Math.max(0, i - ventana/2);
        const fin = Math.min(datos.length, i + ventana/2);
        const ventanaDatos = datos.slice(inicio, fin);
        return ventanaDatos.reduce((a,b) => a + b.power, 0) / ventanaDatos.length;
    });

    // Estacionalidad por hora del d√≠a
    const estacionalidad = Array(24).fill(0).map((_, hora) => {
        const valores = datos.filter(d => d.time.getHours() === hora).map(d => d.power);
        return valores.length > 0 ? valores.reduce((a,b) => a + b, 0) / valores.length : 0;
    });

    // Componente residual (anomal√≠as)
    const residuales = datos.map((d, i) => ({
        time: d.time,
        valor: d.power - (suavizado[i] + estacionalidad[d.time.getHours()])
    })).filter(r => Math.abs(r.valor) > 2 * analyzedData.desviacionEstandar);

    return { suavizado, estacionalidad, residuales };
}

// Sistema de scoring de eficiencia energ√©tica
function calcularScoreEficiencia() {
    const d = analyzedData;
    let score = 100;

    // Penalizaciones ponderadas
    if (d.consumoBase > 150) score -= 25;
    else if (d.consumoBase > 100) score -= 10;

    const cv = (d.desviacionEstandar / d.consumoPromedio) * 100;
    if (cv > 80) score -= 20;
    else if (cv > 50) score -= 10;

    if (d.factorPotenciaPromedio < 0.85) score -= 15;

    const horaPicoRatio = Math.max(...d.promedioPorHora) / d.consumoPromedio;
    if (horaPicoRatio > 2) score -= 15;
    else if (horaPicoRatio > 1.5) score -= 5;

    if (d.comparativoNacional > 50) score -= 20;
    else if (d.comparativoNacional > 20) score -= 10;

    return Math.max(0, Math.min(100, score));
}

// Clustering autom√°tico de dispositivos (k-means simplificado)
function clusterizarDispositivos() {
    const d = analyzedData;
    const picos = d.picos.map(p => ({...p, hora: p.time.getHours()}));

    // Agrupa por similitud de potencia y hora
    const clusters = [];
    const visitados = new Set();

    picos.forEach((pico, i) => {
        if (visitados.has(i)) return;

        const cluster = {
            id: clusters.length,
            tipo: pico.clasificacion,
            picos: [pico],
            horas: new Set([pico.hora]),
            potencias: [pico.diff],
            frecuencia: 1
        };

        // Busca picos similares
        picos.forEach((otro, j) => {
            if (i === j || visitados.has(j)) return;
            const simPotencia = Math.abs(otro.diff - pico.diff) / Math.max(otro.diff, pico.diff) < 0.3;
            const simHora = Math.abs(otro.hora - pico.hora) <= 2;

            if (simPotencia && simHora) {
                cluster.picos.push(otro);
                cluster.horas.add(otro.hora);
                cluster.potencias.push(otro.diff);
                cluster.frecuencia++;
                visitados.add(j);
            }
        });

        clusters.push(cluster);
        visitados.add(i);
    });

    // Calcula estad√≠sticas por cluster
    return clusters.map(c => ({
        ...c,
        potenciaPromedio: c.potencias.reduce((a,b) => a+b, 0) / c.potencias.length,
        horaPreferida: Array.from(c.horas).reduce((a,b) => a+b, 0) / c.horas.size,
        costoMensualEstimado: ((c.potenciaPromedio * 0.5 * c.frecuencia * 30) / 1000) * d.precioKwh
    })).sort((a,b) => b.costoMensualEstimado - a.costoMensualEstimado);
}

// An√°lisis de ciclos de vida de aparatos
function analizarDesgaste() {
    const d = analyzedData;
    const ciclos = d.picos.filter(p => p.clasificacion.categoria === 'Alto consumo');

    // Detecta ciclos de encendido-apagado r√°pidos (posible falla)
    const ciclosRapidos = [];
    for (let i = 1; i < ciclos.length - 1; i++) {
        const tiempoEntreCiclos = (ciclos[i].time - ciclos[i-1].time) / (1000 * 60); // minutos
        if (tiempoEntreCiclos < 30) { // Menos de 30 min
            ciclosRapidos.push({
                aparato: ciclos[i].clasificacion.tipo,
                intervalo: tiempoEntreCiclos,
                timestamp: ciclos[i].time
            });
        }
    }

    return {
        totalCiclos: ciclos.length,
        ciclosRapidos,
        scoreConfiabilidad: ciclosRapidos.length > 0 ? 60 : 100 - Math.min(ciclos.length / 100, 50),
        alerta: ciclosRapidos.length > 3 ? 'Posible aparato defectuoso o mal configurado' : null
    };
}
function calculateCorrelation(arr1, arr2) {
    if (arr1.length !== arr2.length) {
        return NaN;
    }
    let n = 0;
    let sum1 = 0, sum2 = 0, sum1sq = 0, sum2sq = 0, pSum = 0;
    for (let i = 0; i < arr1.length; i++) {
        const val1 = arr1[i];
        const val2 = arr2[i];
        if (val1 !== undefined && val2 !== undefined) {
            n++;
            sum1 += val1;
            sum2 += val2;
            sum1sq += val1 * val1;
            sum2sq += val2 * val2;
            pSum += val1 * val2;
        }
    }
    if (n === 0) {
        return 0;
    }
    const num = pSum - (sum1 * sum2 / n);
    const den = Math.sqrt((sum1sq - sum1 * sum1 / n) * (sum2sq - sum2 * sum2 / n));
    if (den === 0) {
        return 0;
    }
    return num / den;
}
// Implementaci√≥n del an√°lisis causal


function renderCausalAnalysis() {
    const d = analyzedData;

    // An√°lisis de Granger Causality simplificado
    const causalFactors = [];

    const tempCorrelation = calculateCorrelation(d.datosLimpios.map(d => d.temperature), d.datosLimpios.map(d => d.power));
    if (!isNaN(tempCorrelation)) {
        causalFactors.push({
            factor: 'üå°Ô∏è Temperatura ambiente',
            impact: `${(tempCorrelation * 100).toFixed(0)}%`,
            explicacion: tempCorrelation > 0.5 ? 'Alta dependencia del clima' : 'Dependencia moderada'
        });
    }

    // D√≠a de la semana
    const weekendRatio = (d.promedioPorDia[0] + d.promedioPorDia[6]) / 2 / d.promedioPorDia[3];
    causalFactors.push({
        factor: 'üìÖ Fin de semana',
        impact: `${((weekendRatio - 1) * 100).toFixed(0)}%`,
        explicacion: weekendRatio > 1.2 ? 'Uso intensivo en fines de semana' : 'Uso consistente'
    });

    // Habitacional vs Industrial
    const ciclosDia = d.picos.filter(p => p.time.getHours() >= 6 && p.time.getHours() <= 22).length;
    const perfil = ciclosDia / d.picos.length > 0.8 ? 'Residencial' : 'Mixto';

    // Renderizado
    document.getElementById('causalModel').innerHTML = `
        <div class="insight-item">
            <div class="insight-title">üè† Perfil de Uso Detectado: ${perfil}</div>
            <div class="insight-description">
                <strong>Variables explicativas del consumo:</strong>
                <ul>${causalFactors.map(f => `<li><strong>${f.factor}:</strong> ${f.impact} de correlaci√≥n - ${f.explicacion}</li>`).join('')}</ul>
            </div>
            <div class="insight-recommendation">
                üí° Si la temperatura explica >50% de tu consumo, considera aislamiento t√©rmico.
                Si los fines de semana disparan el uso, programa tareas pesadas entre semana.
            </div>
        </div>
    `;

    // Gr√°fico de sensibilidad
    const ctx = document.getElementById('causalChart').getContext('2d');
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Consumo vs Hora del d√≠a',
                data: d.datosLimpios.filter((_,i) => i % 50 === 0).map(dt => ({
                    x: dt.time.getHours() + dt.time.getMinutes() / 60,
                    y: dt.power
                })),
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: 'Hora del d√≠a' } },
                y: { title: { display: true, text: 'Watts' } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}
// Generador de narrativas personalizadas
function generarDiagnosticoNLP() {
    const d = analyzedData;
    const score = d.scoreEficiencia;

    let narrativaMejorable = `Tu hogar consume ${Math.abs(d.comparativoNacional).toFixed(0)}% m√°s que el promedio.`;
    if (d.factorCarga < 0.4) {
        narrativaMejorable += ` Tu factor de carga es bajo (${(d.factorCarga * 100).toFixed(0)}%), lo que sugiere que tu capacidad el√©ctrica no se est√° usando eficientemente.`;
    }
    if (d.rampas.length > 10) {
        narrativaMejorable += ` Se detectaron ${d.rampas.length} arranques bruscos de aparatos, lo cual puede da√±ar los equipos y aumentar el consumo.`;
    }

    let narrativaCritico = `Alerta: Est√°s en el ${(100 - (d.comparativoNacional > 0 ? d.comparativoNacional : 0)).toFixed(0)}% de consumo m√°s alto. Hay desperdicio estructural.`;
    if (d.usoSimultaneo.length > 5) {
        narrativaCritico += ` Frecuentemente se usan aparatos de alto consumo al mismo tiempo, creando picos de demanda innecesarios.`;
    }


    const perfiles = {
        'Excelente': {
            umbral: [80, 100],
            narrativa: `Eres un maestro del ahorro energ√©tico. Tu hogar opera con un ${score.toFixed(0)}% de eficiencia. Tu secreto est√° en el uso racional de equipos y probablemente en tecnolog√≠a eficiente. Tu factor de carga es √≥ptimo con un (${(d.factorCarga * 100).toFixed(0)}%).`,
            meta: 'Mant√©n el liderazgo y considera paneles solares'
        },
        'Eficiente': {
            umbral: [60, 79],
            narrativa: `Tienes buenos h√°bitos con margen de optimizaci√≥n. El principal culpable es ${d.consumoBase > 120 ? 'el consumo fantasma nocturno' : 'la variabilidad diaria que indica uso inestable'}.`,
            meta: 'Focal√≠zate en automatizaci√≥n y en reducir los picos de consumo.'
        },
        'Mejorable': {
            umbral: [40, 59],
            narrativa: narrativaMejorable,
            meta: 'Prioriza el reemplazo de equipos grandes y mejora tus h√°bitos de consumo.'
        },
        'Cr√≠tico': {
            umbral: [0, 39],
            narrativa: narrativaCritico,
            meta: 'Auditor√≠a energ√©tica inmediata necesaria'
        }
    };

    const perfil = Object.entries(perfiles).find(([,p]) => score >= p.umbral[0] && score <= p.umbral[1])[0];

    return `<div class="insight-item">
        <div class="insight-title">üìä Perfil de Eficiencia: ${perfil} (${score.toFixed(0)}/100)</div>
        <div class="insight-description">${perfiles[perfil].narrativa}</div>
        <div class="insight-recommendation">
            <strong>Meta sugerida:</strong> ${perfiles[perfil].meta}
        </div>
    </div>`;
}
function simularOptimizacion() {
    const escenario = document.getElementById('whatIfScenario').value;
    const d = analyzedData;

    let ahorroMensual = 0;
    let descripcion = '';

    switch(escenario) {
        case 'reducirPhantom50':
            ahorroMensual = d.costoFantasmaMes * 0.5;
            descripcion = `Desconectar aparatos standby ahorrar√≠a ${ahorroMensual.toFixed(2)} MXN/mes`;
            break;
        case 'mejorarFP':
            ahorroMensual = d.costoMes * 0.08;
            descripcion = 'Reemplazar cargadores y equipos viejos';
            break;
        case 'reprogramarPico':
            ahorroMensual = d.costoMes * 0.12;
            descripcion = 'Mover lavadora/secadora a 2am';
            break;
        case 'aislarCasa':
            ahorroMensual = d.costoMes * 0.20;
            descripcion = 'Aislamiento t√©rmico reduce AC en 30%';
            break;
    }

    if (ahorroMensual > 0) {
        const roiAnual = (ahorroMensual * 12) / 5000; // Asumiendo inversi√≥n de $5000 en equipos

        document.getElementById('simulationResult').innerHTML = `
            <div class="metric-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white;">
                <div class="metric-icon">üí∞</div>
                <div class="metric-label">Ahorro Mensual Proyectado</div>
                <div class="metric-value">${ahorroMensual.toFixed(2)} MXN</div>
                <div class="metric-detail">
                    Anual: ${(ahorroMensual * 12).toFixed(2)} MXN<br>
                    ROI Estimado: ${(roiAnual * 100).toFixed(0)}% al a√±o
                </div>
            </div>
        `;
        document.getElementById('simulationResult').style.display = 'grid';
    }
}
// Generador de reportes PDF (simulado)
function renderOccupancyMetrics() {

    const d = analyzedData;
    const totalHours = d.occupancy.length;
    const occupiedHours = d.occupancy.filter(o => o.occupied).length;
    const occupancyRate = (occupiedHours / totalHours) * 100;

    const activeHours = d.occupancy.map(o => new Date(o.time).getHours());
    const mostActiveHour = activeHours.reduce((acc, h) => {
        acc[h] = (acc[h] || 0) + 1;
        return acc;
    }, {});
    const peakHour = Object.keys(mostActiveHour).reduce((a, b) => mostActiveHour[a] > mostActiveHour[b] ? a : b);

    document.getElementById('occupancyMetrics').innerHTML = `
        <div class="metric-card">
            <div class="metric-icon">üè†</div>
            <div class="metric-label">Tasa de Ocupaci√≥n</div>
            <div class="metric-value">${occupancyRate.toFixed(1)}%</div>
            <div class="metric-detail">
                ${occupiedHours} de ${totalHours} horas con actividad detectada.
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üïí</div>
            <div class="metric-label">Hora de Mayor Actividad</div>
            <div class="metric-value">${peakHour}:00 - ${parseInt(peakHour)+1}:00</div>
            <div class="metric-detail">
                Hora con la mayor frecuencia de cambios de consumo.
            </div>
        </div>
    `;
}

function renderOccupancyChart() {
    const d = analyzedData;
    const ctx = document.getElementById('occupancyChart').getContext('2d');
    if (chartInstances.occupancy) chartInstances.occupancy.destroy();

    const hours = Array.from({length: 24}, () => 0);
    d.occupancy.forEach(o => {
        if (o.occupied) {
            hours[new Date(o.time).getHours()]++;
        }
    });

    chartInstances.occupancy = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Frecuencia de Ocupaci√≥n',
                data: hours,
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { title: { display: true, text: 'Eventos de Actividad' } }
            }
        }
    });
}

function renderEnvironmentalImpact() {
    const d = analyzedData;
    const co2Factor = 0.444; // kg CO2 / kWh in Mexico
    const treeSequestration = 22; // kg CO2 per year per tree
    const solarSystemCost = 75000; // MXN for a 3kW system

    const monthlyKwh = d.tuConsumoMensual;
    const annualKwh = monthlyKwh * 12;
    const annualCo2 = annualKwh * co2Factor;
    const treesNeeded = annualCo2 / treeSequestration;

    // Solar panel calculations
    const solarProductionKwh = 3 * 5 * 365; // 3kW system, 5 hours sun, 365 days
    const annualSavings = Math.min(annualKwh, solarProductionKwh) * d.precioKwh;
    const roiYears = solarSystemCost / annualSavings;

    document.getElementById('environmentalMetrics').innerHTML = `
        <div class="metric-card">
            <div class="metric-icon">üåç</div>
            <div class="metric-label">Huella de Carbono Anual</div>
            <div class="metric-value">${annualCo2.toFixed(0)} kg CO‚ÇÇ</div>
            <div class="metric-detail">
                Equivale a las emisiones de un auto por ${(annualCo2 / 1.6).toFixed(0)} km.
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üå≥</div>
            <div class="metric-label">√Årboles para Compensar</div>
            <div class="metric-value">${treesNeeded.toFixed(1)}</div>
            <div class="metric-detail">
                Cantidad de √°rboles maduros necesarios para secuestrar tu CO‚ÇÇ anual.
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">‚òÄÔ∏è</div>
            <div class="metric-label">ROI Paneles Solares</div>
            <div class="metric-value">${roiYears.toFixed(1)} a√±os</div>
            <div class="metric-detail">
                Ahorro anual estimado: $${annualSavings.toFixed(2)} MXN
            </div>
        </div>
    `;

    const ctx = document.getElementById('carbonFootprintChart').getContext('2d');
    if(chartInstances.carbon) chartInstances.carbon.destroy();
    chartInstances.carbon = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Tu Hogar', 'Hogar Promedio MX', 'Con Paneles Solares'],
            datasets: [{
                label: 'Huella de Carbono (kg CO‚ÇÇ/a√±o)',
                data: [
                    annualCo2,
                    d.promedioNacionalMensual * 12 * co2Factor,
                    Math.max(0, annualCo2 - solarProductionKwh * co2Factor)
                ],
                backgroundColor: ['#e74c3c', '#95a5a6', '#2ecc71']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { title: { display: true, text: 'kg CO‚ÇÇ por A√±o' } } }
        }
    });
}

function generarReportePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const d = analyzedData;

    doc.setFontSize(22);
    doc.text("Reporte Ejecutivo de Consumo Energ√©tico", 10, 20);

    doc.setFontSize(12);
    doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 10, 30);

    doc.setFontSize(16);
    doc.text("M√©tricas Clave", 10, 45);
    doc.autoTable({
        startY: 50,
        head: [['M√©trica', 'Valor']],
        body: [
            ['Score de Eficiencia', `${d.scoreEficiencia.toFixed(0)}/100`],
            ['Consumo Mensual', `${d.tuConsumoMensual.toFixed(0)} kWh`],
            ['Costo Mensual Estimado', `$${d.costoMes.toFixed(2)} MXN`],
            ['Consumo Fantasma', `${d.consumoBase.toFixed(0)} W ($${d.costoFantasmaMes.toFixed(2)}/mes)`],
            ['Factor de Potencia Promedio', d.factorPotenciaPromedio.toFixed(3)]
        ]
    });

    let finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(16);
    doc.text("Top 5 Picos de Consumo Detectados", 10, finalY);
    doc.autoTable({
        startY: finalY + 5,
        head: [['Fecha y Hora', 'Pico (W)', 'Aparato Estimado']],
        body: d.picos.slice(0, 5).map(p => [
            p.time.toLocaleString('es-MX'),
            p.diff.toFixed(0),
            p.clasificacion.tipo
        ])
    });

    finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(16);
    doc.text("Diagn√≥stico General", 10, finalY);
    const diagnostico = generarDiagnosticoNLP().replace(/<[^>]*>?/gm, ''); // Remove HTML tags
    doc.setFontSize(10);
    doc.text(doc.splitTextToSize(diagnostico, 180), 10, finalY + 5);

    doc.save(`Reporte_Energetico_${new Date().toISOString().slice(0,10)}.pdf`);
}

function exportarAExcel() {
    const d = analyzedData;
    const wb = XLSX.utils.book_new();

    // Hoja 1: Resumen
    const resumen = [
        ["M√©trica", "Valor"],
        ["Score de Eficiencia", d.scoreEficiencia.toFixed(0)],
        ["Consumo Mensual (kWh)", d.tuConsumoMensual.toFixed(0)],
        ["Costo Mensual (MXN)", d.costoMes.toFixed(2)],
        ["Consumo Fantasma (W)", d.consumoBase.toFixed(0)],
        ["Factor de Potencia", d.factorPotenciaPromedio.toFixed(3)]
    ];
    const ws1 = XLSX.utils.aoa_to_sheet(resumen);
    XLSX.utils.book_append_sheet(wb, ws1, "Resumen");

    // Hoja 2: Datos Crudos
    const datosCrudos = d.datosLimpios.map(dato => ({
        Fecha: dato.time.toISOString().slice(0, 10),
        Hora: dato.time.toISOString().slice(11, 19),
        Consumo_W: dato.power,
        Factor_Potencia: dato.powerFactor,
        Temperatura_C: dato.temperature,
        Humedad_pct: dato.humidity
    }));
    const ws2 = XLSX.utils.json_to_sheet(datosCrudos);
    XLSX.utils.book_append_sheet(wb, ws2, "Datos Crudos");

    // Hoja 3: Picos Detectados
    const picos = d.picos.map(p => ({
        Fecha: p.time.toISOString().slice(0, 10),
        Hora: p.time.toISOString().slice(11, 19),
        Pico_W: p.diff.toFixed(0),
        Aparato_Estimado: p.clasificacion.tipo
    }));
    const ws3 = XLSX.utils.json_to_sheet(picos);
    XLSX.utils.book_append_sheet(wb, ws3, "Picos Detectados");

    XLSX.writeFile(wb, `Datos_Energeticos_${new Date().toISOString().slice(0,10)}.xlsx`);
}

    function renderizarAnalisisPredictivo(anomalias, predicciones, clusters, anomaliasIQR) {
        const container = document.getElementById('predictiveAnalysis');
        if (!container) return; // Exit if the container doesn't exist

        let html = '<h3>üîé An√°lisis Predictivo Avanzado</h3>';

        html += '<h4>Detecci√≥n de Anomal√≠as (Z-score)</h4>';
        if (anomalias && anomalias.length > 0) {
            html += '<p>Se detectaron los siguientes consumos anormales significativamente diferentes del promedio:</p>';
            html += '<ul class="insights-list">';
            anomalias.slice(0, 5).forEach(a => { // Show top 5
                html += `<li class="insight-item">
                    <strong>Fecha:</strong> ${a.time.toLocaleString('es-MX')} <br>
                    <strong>Consumo:</strong> ${a.power.toFixed(0)} W (Desviaci√≥n: ${((a.power - analyzedData.consumoPromedio) / analyzedData.desviacionEstandar).toFixed(1)}œÉ)
                </li>`;
            });
            html += '</ul>';
        } else {
            html += '<p>‚úì No se detectaron anomal√≠as significativas. Tu consumo es estable.</p>';
        }

        html += '<hr style="margin: 20px 0;">';

        html += '<h4>Detecci√≥n de Anomal√≠as (IQR)</h4>';
        if (anomaliasIQR && anomaliasIQR.length > 0) {
            html += '<p>Se detectaron los siguientes consumos anormales (IQR):</p>';
            html += '<ul class="insights-list">';
            anomaliasIQR.slice(0, 5).forEach(a => {
                html += `<li class="insight-item">
                    <strong>Fecha:</strong> ${a.time.toLocaleString('es-MX')} <br>
                    <strong>Consumo:</strong> ${a.power.toFixed(0)} W
                </li>`;
            });
            html += '</ul>';
        } else {
            html += '<p>‚úì No se detectaron anomal√≠as significativas con IQR.</p>';
        }

        html += '<hr style="margin: 20px 0;">';
        html += '<h4>Forecasting (Modelo ARIMA)</h4>';
        html += '<p>Predicci√≥n del consumo promedio diario para los pr√≥ximos 30 d√≠as:</p>';
        html += '<div class="chart-container"><canvas id="predictionChartAdvanced"></canvas></div>';

        html += '<hr style="margin: 20px 0;">';
        html += '<h4>Clustering de Electrodom√©sticos (K-means)</h4>';
        if (clusters && clusters.length > 0 && clusters.some(c => c.length > 0)) {
            html += '<p>Se han identificado los siguientes grupos de aparatos seg√∫n su patr√≥n de encendido:</p>';
            clusters.forEach((cluster, i) => {
                if (cluster.length > 0) {
                    const consumoPromedio = cluster.reduce((sum, p) => sum + p.diff, 0) / cluster.length;
                    const clasificacion = clasificarAparato(consumoPromedio);
                    html += `<div class="insight-item" style="border-left-color: ${clasificacion.color}">
                        <strong>Cluster ${i + 1} (${clasificacion.tipo}):</strong> ${cluster.length} eventos <br>
                        <strong>Potencia Promedio:</strong> ${consumoPromedio.toFixed(0)} W
                    </div>`;
                }
            });
        } else {
            html += '<p>No hay suficientes datos para agrupar los electrodom√©sticos.</p>';
        }

        container.innerHTML = html;

        // Render chart after innerHTML is set
        const ctx = document.getElementById('predictionChartAdvanced').getContext('2d');
        if(chartInstances.predictionAdvanced) chartInstances.predictionAdvanced.destroy();

        chartInstances.predictionAdvanced = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 30}, (_, i) => `D√≠a ${i + 1}`),
                datasets: [{
                    label: 'Consumo Predicho (W)',
                    data: predicciones,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Consumo Promedio (W)' }
                    }
                }
            }
        });
    }

    function loadARIMA(m) {
        function uintify (arr) {
            return new Uint8Array(Float64Array.from(arr).buffer)
        }

        function flat (arr) {
            return [].concat.apply([], arr)
        }

        function transpose (arr) {
            return arr[0].map((x, i) => arr.map(x => x[i]))
        }

        function prepare (arr) {
            const farr = flat(arr)
            for (let i = 0; i < farr.length - 2; i++) {
                if (isNaN(farr[i + 1])) {
                    farr[i + 1] = farr[i]
                }
            }
            return farr
        }

        const defaults = {
            method: 0,
            optimizer: 6,
            s: 0,
            verbose: true,
            transpose: false,
            auto: false,
            approximation: 1,
            search: 1
        }

        const params = {
            p: 1,
            d: 0,
            q: 1,
            P: 0,
            D: 0,
            Q: 0
        }

        const paramsAuto = {
            p: 5,
            d: 2,
            q: 5,
            P: 2,
            D: 1,
            Q: 2
        }

        const _fit_sarimax = m.cwrap('fit_sarimax', 'number', ['array', 'array', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'boolean'])
        const _predict_sarimax = m.cwrap('predict_sarimax', 'number', ['number', 'array', 'array', 'array', 'number'])
        const _fit_autoarima = m.cwrap('fit_autoarima', 'number', ['array', 'array', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'number', 'boolean'])
        const _predict_autoarima = m.cwrap('predict_autoarima', 'number', ['number', 'array', 'array', 'array', 'number'])

        function getResults (addr, l) {
            const res = [[], []]
            for (let i = 0; i < l * 2; i++) {
                res[i < l ? 0 : 1].push(m.HEAPF64[addr / Float64Array.BYTES_PER_ELEMENT + i])
            }
            return res
        }

        function ARIMA () {
            if (!(this instanceof ARIMA)) {
                console.warn('Calling ARIMA as a function will be deprecated in the future')
                return (new ARIMA(arguments[2])).train(arguments[0]).predict(arguments[1])
            }
            const opts = arguments[0]
            const o = Object.assign({}, defaults, opts.auto ? paramsAuto : params, opts)
            if (Math.min(o.method, o.optimizer, o.p, o.d, o.q, o.P, o.D, o.Q, o.s) < 0) {
                throw new Error('Model parameter can\'t be negative')
            }
            if ((o.P + o.D + o.Q) === 0) {
                o.s = 0
            } else if (o.s === 0) {
                o.P = o.D = o.Q = 0
            }
            this.options = o
        }

        ARIMA.prototype.train = function (ts, exog = []) {
            const o = this.options
            if (o.transpose && Array.isArray(exog[0])) {
                exog = transpose(exog)
            }
            this.ts = uintify(prepare(ts))
            this.exog = uintify(prepare(exog))
            this.lin = ts.length
            this.nexog = exog.length > 0 ? (Array.isArray(exog[0]) ? exog.length : 1) : 0
            this.model = o.auto
                ? _fit_autoarima(
                    this.ts, this.exog,
                    o.p, o.d, o.q,
                    o.P, o.D, o.Q, o.s,
                    this.nexog,
                    this.lin,
                    o.method,
                    o.optimizer,
                    o.approximation,
                    o.search,
                    o.verbose
                )
                : _fit_sarimax(
                    this.ts, this.exog,
                    o.p, o.d, o.q,
                    o.P, o.D, o.Q, o.s,
                    this.nexog,
                    this.lin,
                    o.method,
                    o.optimizer,
                    o.verbose
                )
            return this
        }

        ARIMA.prototype.fit = function (...a) {
            return this.train(...a)
        }

        ARIMA.prototype.predict = function (l, exog = []) {
            const o = this.options
            if (o.transpose && Array.isArray(exog[0])) {
                exog = transpose(exog)
            }
            const addr = o.auto
                ? _predict_autoarima(
                    this.model,
                    this.ts,
                    this.exog, // old
                    uintify(prepare(exog)), // new
                    l
                )
                : _predict_sarimax(
                    this.model,
                    this.ts,
                    this.exog, // old
                    uintify(prepare(exog)), // new
                    l
                )
            return getResults(addr, l)
        }

        return ARIMA
    }

    async function pronosticoARIMA(datos) {
        const response = await fetch('https://cdn.jsdelivr.net/npm/arima@0.2.5/wasm/native.wasm');
        const buffer = await response.arrayBuffer();
        const module = await Module({ wasmBinary: buffer });
        const ARIMA = loadARIMA(module);

        const potencias = datos.map(d => d.power);
        const hourlyData = [];
        let currentHour = new Date(datos[0].time).getHours();
        let sum = 0;
        let count = 0;
        for (const dato of datos) {
            const hour = new Date(dato.time).getHours();
            if (hour === currentHour) {
                sum += dato.power;
                count++;
            } else {
                hourlyData.push(sum / count);
                currentHour = hour;
                sum = dato.power;
                count = 1;
            }
        }
        hourlyData.push(sum / count);

        const ts = hourlyData.slice(0, 100);
        const arima = new ARIMA({ auto: true, verbose: false }).train(ts);
        const [pred, errors] = arima.predict(30);
        return pred;
    }

    function clusterizarElectrodomesticos(picos, k = 3, maxIteraciones = 100) {
        if (picos.length < k) return [];

        // Inicializar centroides aleatoriamente
        let centroides = picos.slice(0, k).map(p => p.diff);
        let clusters = [];
        let iteracion = 0;
        let convergencia = false;

        while (iteracion < maxIteraciones && !convergencia) {
            // Asignar picos a clusters
            clusters = Array.from({ length: k }, () => []);
            picos.forEach(pico => {
                const distancias = centroides.map(c => Math.abs(c - pico.diff));
                const clusterIdx = distancias.indexOf(Math.min(...distancias));
                clusters[clusterIdx].push(pico);
            });

            // Recalcular centroides
            const nuevosCentroides = clusters.map(cluster => {
                if (cluster.length === 0) return 0;
                return cluster.reduce((sum, p) => sum + p.diff, 0) / cluster.length;
            });

            // Comprobar convergencia
            convergencia = centroides.every((c, i) => Math.abs(c - nuevosCentroides[i]) < 0.1);
            centroides = nuevosCentroides;
            iteracion++;
        }
        return clusters;
    }

    function generarNarrativa() {
        const d = analyzedData;
        const container = document.getElementById('narrativa-container');

        const diaInicio = d.datosLimpios[0].time.toLocaleDateString('es-MX', { weekday: 'long' });
        const diaFin = d.datosLimpios[d.datosLimpios.length - 1].time.toLocaleDateString('es-MX', { weekday: 'long' });
        const picoMaximo = d.picos.reduce((max, p) => p.diff > max.diff ? p : max, d.picos[0]);
        const horaPico = d.promedioPorDia.indexOf(Math.max(...d.promedioPorDia));
        const diaMasConsumo = d.diasSemana[horaPico];

        let narrativa = `
            <p>Nuestra historia comienza un <strong>${diaInicio}</strong>, trazando un viaje a trav√©s de tu consumo de energ√≠a hasta el <strong>${diaFin}</strong>.</p>
            <p>A lo largo de estos d√≠as, tu hogar ha consumido un promedio de <strong>${d.consumoPromedio.toFixed(0)} W</strong>, pero esa es solo una parte de la historia. El consumo fantasma, esa energ√≠a que se escapa silenciosamente, se sit√∫a en <strong>${d.consumoBase.toFixed(0)} W</strong>.</p>
            <p>El momento de mayor demanda de energ√≠a ocurri√≥ el <strong>${picoMaximo.time.toLocaleDateString('es-MX')} a las ${picoMaximo.time.toLocaleTimeString('es-MX')}</strong>, con un pico de <strong>${picoMaximo.diff.toFixed(0)} W</strong>, probablemente debido al encendido de un <strong>${picoMaximo.clasificacion.tipo}</strong>.</p>
            <p>Analizando tus h√°bitos, el <strong>${diaMasConsumo}</strong> es el d√≠a de la semana en que tu hogar consume m√°s energ√≠a. ¬øQuiz√°s es el d√≠a de la colada o de una sesi√≥n de cocina intensiva?</p>
            <p>En resumen, tu hogar es un lugar vibrante y lleno de actividad, con una historia energ√©tica tan √∫nica como t√∫.</p>
        `;

        container.innerHTML = narrativa;
    }

    function renderizarComparadorSemanal() {
        const d = analyzedData;
        const hoy = new Date();
        const haceUnaSemana = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
        const haceDosSemanas = new Date(hoy.getTime() - 14 * 24 * 60 * 60 * 1000);

        const semanaActualDatos = d.datosLimpios.filter(d => d.time >= haceUnaSemana && d.time <= hoy);
        const semanaAnteriorDatos = d.datosLimpios.filter(d => d.time >= haceDosSemanas && d.time < haceUnaSemana);

        if (semanaActualDatos.length === 0 || semanaAnteriorDatos.length === 0) {
            document.getElementById('tab-comparadorSemanal').innerHTML = '<p>No hay suficientes datos para una comparaci√≥n semanal.</p>';
            return;
        }

        const consumoPorDiaActual = Array(7).fill(0);
        semanaActualDatos.forEach(d => {
            consumoPorDiaActual[d.time.getDay()] += d.power / (1000 * 60); // kWh
        });

        const consumoPorDiaAnterior = Array(7).fill(0);
        semanaAnteriorDatos.forEach(d => {
            consumoPorDiaAnterior[d.time.getDay()] += d.power / (1000 * 60); // kWh
        });

        const ctx = document.getElementById('weeklyComparisonChart').getContext('2d');
        if (chartInstances.weeklyComparison) chartInstances.weeklyComparison.destroy();
        chartInstances.weeklyComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: d.diasSemana,
                datasets: [
                    {
                        label: 'Semana Actual',
                        data: consumoPorDiaActual,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Semana Anterior',
                        data: consumoPorDiaAnterior,
                        backgroundColor: 'rgba(231, 76, 60, 0.8)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Consumo (kWh)' }
                    }
                }
            }
        });

        const totalActual = semanaActualDatos.reduce((sum, d) => sum + d.power, 0) / semanaActualDatos.length;
        const totalAnterior = semanaAnteriorDatos.reduce((sum, d) => sum + d.power, 0) / semanaAnteriorDatos.length;
        const diferencia = ((totalActual - totalAnterior) / totalAnterior) * 100;

        document.getElementById('weeklyComparisonMetrics').innerHTML = `
            <div class="metric-card">
                <div class="metric-label">Consumo Promedio (Semana Actual)</div>
                <div class="metric-value">${totalActual.toFixed(0)} W</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Consumo Promedio (Semana Anterior)</div>
                <div class="metric-value">${totalAnterior.toFixed(0)} W</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Diferencia</div>
                <div class="metric-value" style="color: ${diferencia > 0 ? '#e74c3c' : '#2ecc71'}">
                    ${diferencia.toFixed(1)}%
                </div>
            </div>
        `;
    }

    function renderizarVista3D() {
        const container = document.getElementById('threejs-container');
        if (!container || container.querySelector('canvas')) return;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(20, 20, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(10, 20, 5);
        scene.add(directionalLight);

        const d = analyzedData;
        const agrupado = {};
        d.datosLimpios.forEach(dato => {
            const key = dato.time.toISOString().slice(0, 13) + ':00:00';
            if (!agrupado[key]) agrupado[key] = [];
            agrupado[key].push(dato.power);
        });

        const labels = Object.keys(agrupado).sort();
        const valores = labels.map(k => agrupado[k].reduce((a,b) => a+b, 0) / agrupado[k].length);
        const maxPower = Math.max(...valores);

        const gridHelper = new THREE.GridHelper(labels.length, 10);
        scene.add(gridHelper);

        valores.forEach((power, index) => {
            const height = (power / maxPower) * 20;
            const geometry = new THREE.BoxGeometry(0.8, height, 0.8);
            const color = new THREE.Color().setHSL(0.7 - (power / maxPower) * 0.7, 0.8, 0.5);
            const material = new THREE.MeshStandardMaterial({ color: color });
            const cube = new THREE.Mesh(geometry, material);

            cube.position.set(index - labels.length / 2, height / 2, 0);
            scene.add(cube);
        });

        camera.lookAt(0, 5, 0);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    }

    function renderizarAdvancedAnalytics() {
        const d = analyzedData;

        // Render Metrics
        document.getElementById('advancedAnalyticsMetrics').innerHTML = `
            <div class="metric-card">
                <div class="metric-icon">üìä</div>
                <div class="metric-label">Factor de Carga</div>
                <div class="metric-value">${(d.factorCarga * 100).toFixed(1)}%</div>
                <div class="metric-detail">
                    ${d.factorCarga > 0.6 ? '<span class="alert-badge alert-success">‚úì Eficiente</span>' :
                    d.factorCarga > 0.4 ? '<span class="alert-badge alert-info">o Normal</span>' :
                    '<span class="alert-badge alert-warning">‚ö†Ô∏è Mejorable</span>'}
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">‚ö°</div>
                <div class="metric-label">Rampas Pronunciadas</div>
                <div class="metric-value">${d.rampas.length}</div>
                <div class="metric-detail">Eventos de cambio brusco de consumo</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üîÑ</div>
                <div class="metric-label">Usos Simult√°neos</div>
                <div class="metric-value">${d.usoSimultaneo.length}</div>
                <div class="metric-detail">Pares de aparatos encendidos al mismo tiempo</div>
            </div>
        `;

        // Render Hourly Efficiency Chart
        const ctx = document.getElementById('hourlyEfficiencyChart').getContext('2d');
        if (chartInstances.hourlyEfficiency) chartInstances.hourlyEfficiency.destroy();
        chartInstances.hourlyEfficiency = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + ':00'),
                datasets: [{
                    label: 'Eficiencia (%)',
                    data: d.eficienciaHoraria,
                    backgroundColor: d.eficienciaHoraria.map(e => e > 80 ? '#2ecc71' : e > 60 ? '#f1c40f' : '#e74c3c')
                }]
            },
            options: {
                responsive: true,
                scales: { y: { min: 0, max: 100, title: { display: true, text: 'Eficiencia (%)' } } }
            }
        });

        // Render Ramps List
        const rampsHtml = d.rampas.slice(0, 20).map(r => `
            <div class="appliance-item" style="border-left-color: ${r.tipo === 'Subida' ? '#e74c3c' : '#3498db'}">
                <div class="appliance-time">${r.time.toLocaleString('es-MX')}</div>
                <div class="appliance-power"><strong>${r.tipo}:</strong> ${r.velocidad.toFixed(0)} W/s</div>
            </div>
        `).join('');
        document.getElementById('rampsList').innerHTML = rampsHtml || '<p>No se detectaron rampas significativas.</p>';

        // Render Simultaneous Use List
        const simultaneousHtml = d.usoSimultaneo.slice(0, 20).map(s => `
            <div class="appliance-item">
                <div class="appliance-time">${s.time.toLocaleString('es-MX')}</div>
                <div class="appliance-type"><strong>${s.aparato1}</strong> + <strong>${s.aparato2}</strong></div>
                <div class="appliance-power">Potencia combinada: ${s.potenciaTotal.toFixed(0)} W</div>
            </div>
        `).join('');
        document.getElementById('simultaneousUseList').innerHTML = simultaneousHtml || '<p>No se detectaron usos simult√°neos frecuentes.</p>';
    }

    function enviarMensajeChat() {
        const input = document.getElementById('chatInput');
        const mensaje = input.value.trim();
        if (mensaje === '') return;

        const chatWindow = document.getElementById('chatWindow');

        // Display user message
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'chat-message user-message';
        userMessageDiv.textContent = mensaje;
        chatWindow.appendChild(userMessageDiv);

        // Process and get bot response
        const botResponse = procesarPreguntaChat(mensaje);

        // Display bot message
        setTimeout(() => {
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'chat-message bot-message';
            botMessageDiv.textContent = botResponse;
            chatWindow.appendChild(botMessageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
        }, 500);

        input.value = '';
    }

    function procesarPreguntaChat(pregunta) {
        const d = analyzedData;
        pregunta = pregunta.toLowerCase();

        if (pregunta.includes('consumo') && pregunta.includes('subi√≥')) {
            if (d.tendencia > 0.01) {
                return `Tu consumo ha subido principalmente por una tendencia al alza del ${(d.tendencia * 100).toFixed(1)}% diario. Revisa si has instalado nuevos aparatos.`;
            } else {
                const diaMasConsumo = d.diasSemana[d.promedioPorDia.indexOf(Math.max(...d.promedioPorDia))];
                return `No detecto una subida general, pero tu d√≠a de mayor consumo es el ${diaMasConsumo}. Quiz√°s la subida se concentr√≥ ese d√≠a.`;
            }
        } else if (pregunta.includes('aparato') && pregunta.includes('m√°s consume')) {
            const picoMaximo = d.picos.reduce((max, p) => p.diff > max.diff ? p : max, d.picos[0]);
            return `El aparato que gener√≥ el mayor pico de consumo fue un(a) ${picoMaximo.clasificacion.tipo}, con un pico de ${picoMaximo.diff.toFixed(0)} W.`;
        } else if (pregunta.includes('costo') && pregunta.includes('mes')) {
            return `Tu costo mensual proyectado es de $${d.costoMes.toFixed(2)} MXN.`;
        } else if (pregunta.includes('ahorrar')) {
            return `Puedes ahorrar hasta $${d.ahorroMensual.toFixed(2)} MXN al mes si reduces tu consumo fantasma. Tambi√©n te recomiendo revisar los aparatos que usas en la hora pico (${d.promedioPorHora.indexOf(Math.max(...d.promedioPorHora))}:00).`;
        } else {
            return "Lo siento, no entend√≠ esa pregunta. Puedes preguntarme sobre: '¬øpor qu√© subi√≥ mi consumo?', '¬øqu√© aparato consume m√°s?', '¬øcu√°l es mi costo mensual?' o '¬øc√≥mo puedo ahorrar?'.";
        }
    }

    function renderizarAlertasYAparatos() {
        generarAlertasInteligentes();
        renderizarScoringAparatos();
        popularSelectorAparatos();
    }

    function popularSelectorAparatos() {
        const d = analyzedData;
        const selector = document.getElementById('aparatoSeleccionado');
        selector.innerHTML = '<option value="">Selecciona uno...</option>';
        d.clusters.forEach((cluster, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${cluster.tipo.tipo} (${cluster.potenciaPromedio.toFixed(0)} W)`;
            selector.appendChild(option);
        });
    }

    function calcularReemplazo() {
        const d = analyzedData;
        const selector = document.getElementById('aparatoSeleccionado');
        const clusterIndex = selector.value;
        if (clusterIndex === '') return;

        const cluster = d.clusters[clusterIndex];
        const costoAparatoNuevo = parseFloat(document.getElementById('costoAparatoNuevo').value);
        const consumoAparatoNuevo = parseFloat(document.getElementById('consumoAparatoNuevo').value);

        // Ahorro en consumo por hora de uso
        const ahorroWatts = cluster.potenciaPromedio - consumoAparatoNuevo;

        // Estimaci√≥n de horas de uso mensual (basado en frecuencia)
        // Asumimos 1 hora de uso por cada encendido detectado
        const horasUsoMensual = cluster.frecuencia * (30 / d.diasDatos);

        const ahorroKwhMensual = (ahorroWatts * horasUsoMensual) / 1000;
        const ahorroMonetarioMensual = ahorroKwhMensual * d.precioKwh;

        const roiMeses = costoAparatoNuevo / ahorroMonetarioMensual;

        const resultadoContainer = document.getElementById('resultadoReemplazo');
        if (ahorroMonetarioMensual > 0) {
            resultadoContainer.innerHTML = `
                <div class="metric-card alert-success">
                    <div class="metric-icon">üí∞</div>
                    <div class="metric-label">Ahorro Mensual Estimado</div>
                    <div class="metric-value">$${ahorroMonetarioMensual.toFixed(2)}</div>
                </div>
                <div class="metric-card alert-info">
                    <div class="metric-icon">‚è≥</div>
                    <div class="metric-label">Retorno de Inversi√≥n (ROI)</div>
                    <div class="metric-value">${(roiMeses / 12).toFixed(1)} a√±os</div>
                    <div class="metric-detail">(${roiMeses.toFixed(0)} meses)</div>
                </div>
            `;
        } else {
             resultadoContainer.innerHTML = `
                <div class="metric-card alert-danger">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-label">No Genera Ahorro</div>
                    <div class="metric-value">El aparato nuevo consume m√°s</div>
                </div>
            `;
        }
    }

    function calcularScoreAparato(cluster) {
        const d = analyzedData;
        let score = 100;

        // Penalizaci√≥n por alto consumo
        const ratioConsumo = cluster.potenciaPromedio / d.consumoMaximo;
        score -= ratioConsumo * 40; // Max -40 puntos

        // Penalizaci√≥n por frecuencia
        const ratioFrecuencia = cluster.frecuencia / d.picos.length;
        score -= ratioFrecuencia * 30; // Max -30 puntos

        // Penalizaci√≥n por costo
        const ratioCosto = cluster.costoMensualEstimado / d.costoMes;
        score -= ratioCosto * 30; // Max -30 puntos

        return Math.max(10, score.toFixed(0)); // M√≠nimo 10 puntos
    }

    function renderizarScoringAparatos() {
        const d = analyzedData;
        const tbody = document.querySelector('#scoringTable tbody');
        tbody.innerHTML = ''; // Limpiar tabla

        d.clusters.forEach(cluster => {
            const score = calcularScoreAparato(cluster);
            const scoreColor = score > 80 ? 'alert-success' : score > 60 ? 'alert-info' : score > 40 ? 'alert-warning' : 'alert-danger';

            const row = `
                <tr>
                    <td>${cluster.tipo.tipo}</td>
                    <td>${cluster.potenciaPromedio.toFixed(0)} W</td>
                    <td>${cluster.frecuencia} veces</td>
                    <td>$${cluster.costoMensualEstimado.toFixed(2)}</td>
                    <td><span class="alert-badge ${scoreColor}">${score}/100</span></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function generarAlertasInteligentes() {
    const d = analyzedData;
    const container = document.getElementById('alertasInteligentesContainer');
    let alertasHTML = '';

    // 1. Alerta de pico reciente
    const ahora = new Date();
    const picosRecientes = d.picos.filter(p => (ahora - p.time) / (1000 * 60 * 60) <= 2);
    if (picosRecientes.length > 0) {
        const picoMasAltoReciente = picosRecientes.reduce((max, p) => p.diff > max.diff ? p : max);
        alertasHTML += `
            <div class="insight-item">
                <div class="insight-title"><span class="alert-badge alert-warning">AVISO</span> Consumo Elevado Recientemente</div>
                <div class="insight-description">
                    Hace menos de 2 horas se detect√≥ un pico de <strong>${picoMasAltoReciente.diff.toFixed(0)} W</strong>, causado por un <strong>${picoMasAltoReciente.clasificacion.tipo}</strong>.
                    Tu consumo en ese momento fue un <strong>${((picoMasAltoReciente.power / d.consumoPromedio - 1) * 100).toFixed(0)}%</strong> superior a tu promedio.
                </div>
            </div>`;
    }

    // 2. Alerta de aumento de consumo base
    const mitad = Math.floor(d.datosLimpios.length / 2);
    const primeraMitad = d.datosLimpios.slice(0, mitad);
    const segundaMitad = d.datosLimpios.slice(mitad);
    const consumoBasePrimera = primeraMitad.map(dato => dato.power).sort((a,b)=>a-b)[Math.floor(primeraMitad.length * 0.1)];
    const consumoBaseSegunda = segundaMitad.map(dato => dato.power).sort((a,b)=>a-b)[Math.floor(segundaMitad.length * 0.1)];

    if (consumoBaseSegunda > consumoBasePrimera * 1.2) {
         alertasHTML += `
            <div class="insight-item">
                <div class="insight-title"><span class="alert-badge alert-danger">ALERTA</span> Posible Fuga Detectada</div>
                <div class="insight-description">
                    Tu consumo base (fantasma) ha aumentado de <strong>${consumoBasePrimera.toFixed(0)} W</strong> a <strong>${consumoBaseSegunda.toFixed(0)} W</strong> durante el periodo analizado.
                    Esto sugiere un nuevo aparato conectado permanentemente o una posible fuga el√©ctrica.
                </div>
            </div>`;
    }

    // 3. Alerta de presupuesto
    if (d.costoProyectado30d > d.presupuestoMensual) {
        alertasHTML += `
            <div class="insight-item">
                <div class="insight-title"><span class="alert-badge alert-danger">ALERTA</span> Vas a Rebasar tu Presupuesto Mensual</div>
                <div class="insight-description">
                    Si tu consumo sigue la tendencia actual, tu pr√≥ximo recibo ser√° de aproximadamente <strong>$${d.costoProyectado30d.toFixed(2)} MXN</strong>,
                    superando tu presupuesto de <strong>$${d.presupuestoMensual.toFixed(2)} MXN</strong>.
                </div>
                <div class="insight-recommendation">üí° Revisa la pesta√±a de "Recomendaciones" para encontrar formas de reducir tu consumo.</div>
            </div>`;
    }

    // Alerta predictiva
    alertasHTML += `
        <div class="insight-item">
            <div class="insight-title"><span class="alert-badge alert-info">PREDICCI√ìN</span> Proyecci√≥n de Recibo</div>
            <div class="insight-description">
                Si mantienes tus h√°bitos de consumo actuales, tu pr√≥ximo recibo de luz ser√° de aproximadamente <strong>$${d.costoProyectado30d.toFixed(2)} MXN</strong>.
            </div>
        </div>`;


    if (alertasHTML === '') {
        alertasHTML = '<p>No se han generado nuevas alertas. ¬°Buen trabajo manteniendo tu consumo bajo control!</p>';
    }

    container.innerHTML = alertasHTML;
}

    function renderizarLogros() {
        const d = analyzedData;
        const logros = [
            {
                id: 'vampire_slayer',
                titulo: 'üßõ‚Äç‚ôÇÔ∏è Caza Vampiros',
                descripcion: 'Mantuviste tu consumo fantasma por debajo de 75W durante al menos 3 d√≠as.',
                condicion: () => d.consumoBase < 75 && d.diasDatos >= 3
            },
            {
                id: 'efficiency_expert',
                titulo: 'üë®‚Äçüî¨ Experto en Eficiencia',
                descripcion: 'Lograste un factor de potencia promedio superior a 0.95.',
                condicion: () => d.factorPotenciaPromedio > 0.95
            },
            {
                id: 'peak_controller',
                titulo: 'üìâ Controlador de Picos',
                descripcion: 'No tuviste m√°s de 5 picos de alto consumo en una semana.',
                condicion: () => (d.categorias['Alto consumo'] || 0) <= (5 * (d.diasDatos / 7))
            },
            {
                id: 'eco_warrior',
                titulo: 'üå≥ Guerrero Ecol√≥gico',
                descripcion: 'Tu consumo mensual est√° por debajo del promedio nacional.',
                condicion: () => d.comparativoNacional < 0
            },
            {
                id: 'stable_consumer',
                titulo: 'üßò Consumo Zen',
                descripcion: 'Tu desviaci√≥n est√°ndar de consumo es menor al 30% de tu promedio.',
                condicion: () => (d.desviacionEstandar / d.consumoPromedio) < 0.3
            },
            {
                id: 'night_owl',
                titulo: 'ü¶â B√∫ho Nocturno',
                descripcion: 'Tu mayor consumo promedio ocurre entre las 10 PM y las 6 AM.',
                condicion: () => {
                    const horaPico = d.promedioPorHora.indexOf(Math.max(...d.promedioPorHora));
                    return horaPico >= 22 || horaPico <= 6;
                }
            }
        ];

        let unlockedAchievements = JSON.parse(localStorage.getItem('unlocked_achievements')) || [];

        logros.forEach(logro => {
            if (logro.condicion() && !unlockedAchievements.includes(logro.id)) {
                unlockedAchievements.push(logro.id);
            }
        });

        localStorage.setItem('unlocked_achievements', JSON.stringify(unlockedAchievements));

        const container = document.getElementById('logrosContainer');
        container.innerHTML = ''; // Limpiar

        if (unlockedAchievements.length === 0) {
            container.innerHTML = '<p>A√∫n no has desbloqueado ning√∫n logro. ¬°Sigue optimizando tu consumo!</p>';
            return;
        }

        unlockedAchievements.forEach(id => {
            const logro = logros.find(l => l.id === id);
            container.innerHTML += `
                <div class="metric-card" style="text-align: center; background: #f0f8ff;">
                    <div class="metric-icon" style="font-size: 3.5em;">${logro.titulo.split(' ')[0]}</div>
                    <div class="metric-label" style="font-size: 1.2em; font-weight: bold; color: #333; margin-top: 10px;">${logro.titulo.split(' ').slice(1).join(' ')}</div>
                    <div class="metric-detail" style="font-size: 0.9em; margin-top: 5px;">${logro.descripcion}</div>
                </div>
            `;
        });
    }

    function calcularACF(series, maxLag) {
        const n = series.length;
        const mean = series.reduce((a, b) => a + b, 0) / n;
        const variance = series.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0);

        const acf = [];
        for (let lag = 0; lag <= maxLag; lag++) {
            let covariance = 0;
            for (let i = lag; i < n; i++) {
                covariance += (series[i] - mean) * (series[i - lag] - mean);
            }
            acf.push(covariance / variance);
        }
        return acf;
    }

    function renderACFChart() {
        const d = analyzedData;
        if (!d.acf) return;

        const ctx = document.getElementById('acfChart').getContext('2d');
        if (chartInstances.acf) chartInstances.acf.destroy();

        const confidenceInterval = 1.96 / Math.sqrt(d.datosLimpios.length);

        chartInstances.acf = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: d.acf.length}, (_, i) => `Lag ${i}`),
                datasets: [{
                    label: 'ACF',
                    data: d.acf,
                    backgroundColor: d.acf.map(v => Math.abs(v) > confidenceInterval ? '#e74c3c' : '#667eea')
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: [{
                            type: 'line',
                            mode: 'horizontal',
                            scaleID: 'y',
                            value: confidenceInterval,
                            borderColor: 'grey',
                            borderWidth: 1,
                            borderDash: [5, 5]
                        }, {
                            type: 'line',
                            mode: 'horizontal',
                            scaleID: 'y',
                            value: -confidenceInterval,
                            borderColor: 'grey',
                            borderWidth: 1,
                            borderDash: [5, 5]
                        }]
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'Coeficiente de Autocorrelaci√≥n' }
                    }
                }
            }
        });
    }

    function calcularFFT(series) {
        const n = series.length;
        if (n === 0 || (n & (n - 1)) !== 0) { // Check if n is a power of 2
            console.error("FFT requires a power-of-two length series.");
            return [];
        }

        const re = Float64Array.from(series);
        const im = new Float64Array(n).fill(0);

        // Cooley-Tukey FFT
        for (var i = 0; i < n; i++) {
            for(var j = 0, h = i, k = n; k >>= 1; h >>= 1)
                j = (j << 1) | (h & 1);
            if (j > i) {
                [re[j], re[i]] = [re[i], re[j]];
                [im[j], im[i]] = [im[i], im[j]];
            }
        }

        for(let hN = 1; hN * 2 <= n; hN *= 2) {
            for (let i = 0; i < n; i += hN * 2) {
                for (let j = i; j < i + hN; j++) {
                    const cos = Math.cos(Math.PI * (j - i) / hN);
                    const sin = Math.sin(Math.PI * (j - i) / hN);
                    const tre = re[j + hN] * cos + im[j + hN] * sin;
                    const tim = -re[j + hN] * sin + im[j + hN] * cos;
                    re[j + hN] = re[j] - tre;
                    im[j + hN] = im[j] - tim;
                    re[j] += tre;
                    im[j] += tim;
                }
            }
        }

        const amplitudes = re.map((r, i) => Math.sqrt(r * r + im[i] * im[i]));
        return amplitudes.slice(1, n / 2);
    }

    function renderFFTChart() {
        const d = analyzedData;
        if (!d.fft) return;

        const ctx = document.getElementById('fftChart').getContext('2d');
        if (chartInstances.fft) chartInstances.fft.destroy();

        chartInstances.fft = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: d.fft.length}, (_, i) => `${i + 1} cycles`),
                datasets: [{
                    label: 'Amplitud',
                    data: d.fft,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { title: { display: true, text: 'Amplitud' } },
                    x: { title: { display: true, text: 'Frecuencia (ciclos por periodo de muestreo)' } }
                }
            }
        });
    }
    </script>
</body>
</html>